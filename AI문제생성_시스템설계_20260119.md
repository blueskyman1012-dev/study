# AI 문제 생성 시스템 설계

**작성일**: 2026-01-19
**상태**: 구현 완료
**목적**: AI가 자동으로 문제를 생성하고, 검증하여 던전에 추가하는 시스템

---

## 구현 완료 내역

### 생성된 파일
- `app/src/services/ProblemGeneratorService.js` - AI 문제 생성 서비스 (수학 전용)

### 수정된 파일
- `app/src/game/Game.js`
  - ProblemGeneratorService import 추가
  - `startDungeon()` 수정: 문제 부족 시 자동 생성 (최소 10개)
  - `onWrongAnswer()` 수정: ProblemGeneratorService 우선 사용
  - `generateSimilarWithProblemGenerator()` 메서드 추가
  - `showAIGenerateMenu()` 메서드 추가: 수동 문제 생성 UI
  - `showGeneratingScreen()` 메서드 추가
  - 메인 화면에 'AI 수학문제 생성' 버튼 추가

### 구현된 기능
1. **던전 시작 시 자동 생성**: 문제가 10개 미만이면 AI가 부족한 만큼 자동 생성
2. **오답 시 유사 문제 생성**: 틀린 문제와 비슷한 유형의 문제 2개 자동 생성
3. **수동 문제 생성**: 메인 화면에서 주제/난이도/개수 선택하여 문제 생성

---

## 1. 시스템 개요

```
[사용자 요청] → [AI 문제 생성] → [AI 자체 검증] → [던전 추가]
      ↑              ↓
   [과목/주제 선택]  [오답 생성]
```

---

## 2. 핵심 기능

### 2.1 문제 생성 (ProblemGeneratorService)

| 기능 | 설명 | 상태 |
|------|------|------|
| `generateProblems(topic, difficulty, count)` | 주제별 문제 생성 | ✅ 완료 |
| `generateSimilar(originalProblem)` | 유사 문제 생성 | ✅ 완료 |
| `validateProblem(problem)` | AI 자체 검증 | ✅ 완료 |
| `generateRandom(count)` | 랜덤 주제 문제 생성 | ✅ 완료 |
| `getTopics()` | 주제 목록 반환 | ✅ 완료 |

### 2.2 지원 주제 (수학)

| 키 | 주제명 | 예시 |
|----|--------|------|
| linear | 일차방정식 | 2x + 3 = 7 |
| quadratic | 이차방정식 | x² - 5x + 6 = 0 |
| factoring | 인수분해 | x² + 5x + 6 |
| function | 함수 | f(x) = 2x + 1, f(3) = ? |
| inequality | 부등식 | 2x - 3 > 5 |
| fraction | 분수 계산 | 1/2 + 1/3 |
| percentage | 비율/퍼센트 | 20의 30% |
| sequence | 수열 | 등차수열 합 |
| probability | 확률 | 주사위 확률 |
| geometry | 도형 | 삼각형 넓이 |

### 2.3 자체 검증 (Self-Validation)

AI가 생성한 문제를 다시 AI가 풀어서 검증:

```
1. 문제 생성
2. AI가 문제 풀이 시도
3. 정답 일치 확인
4. 불일치 시 재생성 또는 폐기
```

### 2.4 오답 생성 규칙

```javascript
// 정답 기반 오답 생성
{
  // 숫자 정답
  "5" → ["3", "7", "-5", "10"]

  // 복수 정답 (이차방정식)
  "2, -3" → ["2, 3", "-2, -3", "1, -3", "3, -2"]

  // 분수
  "1/2" → ["1/3", "2/3", "1/4", "3/2"]
}
```

---

## 3. Prompt 설계

### 문제 생성 Prompt

```
당신은 한국 고등학교 수학 선생님입니다.

## 작업
{주제} 문제를 {N}개 만드세요.
예시: {예시}

## 조건
- 난이도: {쉬움/보통/어려움}
- 정답은 반드시 숫자 (예: "5", "-3", "2, -3")
- 이차방정식은 두 근을 쉼표로 구분 (예: "2, -3")
- 학생이 자주 하는 실수를 반영한 오답 3개 포함
- 오답은 정답과 비슷한 숫자로 (예: 정답 5 → 오답 3, 7, -5)

## JSON 출력 (반드시 이 형식만)
{
  "problems": [
    {
      "question": "문제 내용",
      "answer": "5",
      "answers": ["5"],
      "choices": ["5", "3", "7", "-5"],
      "correctIndex": 0,
      "explanation": "풀이: 2x + 3 = 13, 2x = 10, x = 5",
      "difficulty": 2,
      "topic": "일차방정식"
    }
  ]
}

## 필수
- choices[0]은 반드시 정답
- 모든 choices는 숫자만
- explanation은 단계별 풀이
```

### 검증 Prompt

```
다음 수학 문제를 풀어서 정답을 확인하세요.

문제: {question}
제시된 정답: {answer}

## 작업
1. 문제를 직접 풀어보세요
2. 계산한 정답과 제시된 정답이 일치하는지 확인

## JSON 출력
{
  "calculatedAnswer": "계산한 정답",
  "isCorrect": true,
  "explanation": "풀이 과정"
}
```

---

## 4. 자동 던전 추가 흐름 (구현 완료)

```javascript
// 1. 던전 시작 시 문제 부족하면 자동 생성
async startDungeon() {
  const MIN_MONSTERS = 10;
  if (this.monsters.length < MIN_MONSTERS && problemGeneratorService.hasApiKey()) {
    const needCount = MIN_MONSTERS - this.monsters.length;
    const problems = await problemGeneratorService.generateRandom(needCount);
    // 던전에 추가...
  }
}

// 2. 오답 시 유사 문제 자동 생성
async onWrongAnswer() {
  if (problemGeneratorService.hasApiKey()) {
    this.generateSimilarWithProblemGenerator(this.currentMonster);
  } else if (geminiService.hasApiKey()) {
    this.generateSimilarMonsters(this.currentMonster);
  }
}

// 3. 수동 문제 생성 (메인 화면 버튼)
async showAIGenerateMenu() {
  // 주제, 난이도, 개수 선택
  const problems = await problemGeneratorService.generateProblems(topic, difficulty, count);
  // 던전에 추가...
}
```

---

## 5. UI 추가 (구현 완료)

### 메인 화면
- SmilePrint API 키 설정 시 **🤖 AI 수학문제 생성** 버튼 표시
- 클릭 시 주제/난이도/개수 선택 다이얼로그

### 문제 생성 흐름
```
1. 🤖 AI 수학문제 생성 버튼 클릭
2. 주제 선택 (1-10)
3. 난이도 선택 (쉬움/보통/어려움)
4. 개수 입력 (1-10)
5. AI 문제 생성 중... 화면 표시
6. 생성 완료 알림 (예시 문제 표시)
```

---

## 6. API 연동

### SmilePrint API (권장)
- 엔드포인트: `https://caricature-api-rust.wizice.com/api/v1/analyze/image`
- 모델: `gemini-2.0-flash-exp`
- ProblemGeneratorService와 ImageAnalysisService가 같은 API 키 공유

### Gemini API (폴백)
- ProblemGeneratorService 실패 시 GeminiService로 폴백
- 유사 문제 생성에도 사용 가능

---

## 7. 향후 개선 사항

1. **영어/국어 과목 추가**: 현재 수학만 지원
2. **약점 기반 문제 생성**: 틀린 주제에 대한 집중 문제 생성
3. **문제 검증 강화**: AI 자체 검증 결과 기반 필터링
4. **UI 개선**: 드롭다운 메뉴로 주제/난이도 선택
