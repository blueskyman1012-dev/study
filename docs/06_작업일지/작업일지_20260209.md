# 작업일지 - 2026-02-09

---

## 1. 기능 구현

### 1-1. 과목별 문제유형 통계
- **파일**: `StatsManager.js`, `StatsScreen.js`, `i18n.js`
- **내용**: 통계 화면에서 과목별(수학/과학/영어/국어) 문제유형(topic)의 정답률, 오답률, 시도 횟수를 확인할 수 있도록 구현
- **상세**:
  - `StatsManager.js`에 `subjectTopics` 집계 로직 추가
  - `StatsScreen.js`에서 기존 글로벌 유형 TOP8 → 과목별 유형 카드로 교체
  - 4개 언어 번역 키 추가

### 1-2. 공격 이펙트 2.5배 확대
- **파일**: `EffectSystem.js`
- **내용**: 데미지 텍스트 폰트 크기 2.5배 증가 (20→50px, 24→60px), glow 항상 활성화

---

## 2. 버그 수정 (1차)

### 2-1. 타이머 delta 폭주
- **파일**: `BattleManager.js`
- **문제**: `game.lastTime = 0` 설정 후 다음 프레임에서 `Date.now() - 0` = 거대한 delta → 타이머 즉시 소진
- **수정**: `lastTime = -1`로 변경 (`updateBattle`이 `lastTime > 0` 체크하므로 안전하게 타이머 정지)

### 2-2. 최종보스 연속 오답 페널티 완화
- **파일**: `BattleManager.js`
- **수정**: HP 피해 80→60, 추가 피해 -10→-5, 몬스터 HP 회복 25→15

### 2-3. 몬스터 풀 고갈 방지
- **파일**: `Game.js`
- **문제**: `_reviveClearedMonsters()`가 승리 시에만 호출 → 패배 시 몬스터 영구 소실
- **수정**: 모든 런 종료 시(승리/패배) 부활 호출

### 2-4. 선택지 정답 포함 검증
- **파일**: `MonsterManager.js`
- **문제**: 셔플 후 정답이 선택지에 없을 수 있음
- **수정**: `_prepareChoices()` 후 `correctIndex === -1`이면 강제 삽입 + 재셔플

### 2-5. 스킵 페널티 상한
- **파일**: `BattleManager.js`
- **수정**: `Math.min(30, 10 + (skipCount - 1) * 5)` → 최대 HP-30

### 2-6. API 타임아웃 설정
- **파일**: `ApiService.js`
- **수정**: `AbortController`로 30초 타임아웃 추가

### 2-7. 초반 골드 보너스
- **파일**: `BattleManager.js`
- **수정**: 레벨 10 이하 골드 1.5배 배율 적용

---

## 3. 꾸미기 아이템 크로스 디바이스 동기화 수정

### 3-1. 구매 배열 병합
- **파일**: `ApiService.js` (`downloadPlayerData`)
- **문제**: `if (extra.cosmetics) player.cosmetics = extra.cosmetics;` → 서버 값으로 단순 교체, 로컬 구매 내역 유실
- **수정**: `purchasedThemes`, `purchasedParticles`, `purchasedDamageText`, `purchasedFlash` 배열을 로컬+서버 union 병합, 활성 선택은 서버 우선

### 3-2. 마이그레이션 시 서버 동기화
- **파일**: `PlayerManager.js`
- **수정**: cosmetics 마이그레이션 발생 시 서버에 즉시 `putPlayer()` 호출

---

## 4. 버그 수정 (2차 - 코드 전체 점검)

### 4-1. 런타임 크래시 방지 (Critical 5건)
| 파일 | 수정 내용 |
|------|-----------|
| `Game.js` | `endRun()`에 `currentRun` null 체크 추가 |
| `MonsterManager.js` | `fillQuestionsFromOtherMonsters()`에 `questions` 배열 초기화 |
| `MonsterManager.js` | `autoGenerateQuestions()`에 `questions` 배열 초기화 |
| `GeminiService.js` | `imageData.split(',')[1]` → 콤마 포함 여부 체크 후 split |
| `ProblemGeneratorService.js` | `dataURL.split(',')[1]` → 동일 포맷 검증 |

### 4-2. 비동기 await 누락 수정 (11건)
| 파일 | 수정 내용 |
|------|-----------|
| `BattleManager.js` | `playerManager.save()` 6곳 await 추가 |
| `AchievementManager.js` | `unlock()`, `claimDailyReward()`, `claimWeeklyReward()` async 전환 + await 3곳 |
| `ShopManager.js` | `equipCosmetic()` async 전환 + await 2곳 |

---

## 5. 게임 전체 점검 2차 및 P0/P1 수정

### 5-1. 점검 문서 작성
- **파일**: `docs/05_테스트_개선/게임전체점검2차_20260209.md`
- **내용**: UI/UX 21건, 게임 밸런스 10건, 서비스/인프라 32건 총 63건 발견, P0~P3 우선순위 정리

### 5-2. P0 즉시 수정 (3건)
| 항목 | 파일 | 수정 내용 |
|------|------|-----------|
| 동기화 Race Condition | `main.js` | `_syncing` 플래그 + `finally` 블록으로 동시 동기화 방지 |
| API 키 URL 노출 | `GeminiService.js` | `?key=` 쿼리 → `x-goog-api-key` 헤더 전송 |
| 업적 ID/조건 불일치 | `constants.js`, `AchievementManager.js` | 11개 업적 조건값을 ID와 일치하도록 수정 |

### 5-3. P1 빠른 수정 (4건)
| 항목 | 파일 | 수정 내용 |
|------|------|-----------|
| 보스 HP 회복 상한 | `BattleManager.js` | `_healCount` 추가, 중간보스 5회/최종보스 10회 제한 |
| 초반 5문제 난이도 제한 | `MonsterManager.js` | `totalAnswers < 5`일 때 난이도 1~2만 선택 |
| 결과 화면 스크롤 | `ResultScreen.js` | `scrollMaxY` 계산 + scrollY 오프셋 적용 |
| 전투 하단 버튼 간격 | `BattleScreen.js` | 5px → 8px 간격, 위치 재배치 |

---

## 6. 보스 HP 회복 최종 조정
- **파일**: `BattleManager.js`
- **변경**:
  - 일반 몬스터/일반 보스: 오답 시 HP 회복 제거
  - 중간 보스: 오답 시 HP+30 회복 (최대 5회)
  - 최종 보스: 연속 오답 시 HP+15 회복 (최대 10회)

---

## 커밋 이력

| 커밋 | 내용 |
|------|------|
| `44241cd` | 성능 최적화, AI 생성 속도 개선, AI 자동생성 버그 수정 |
| `584f45b` | P0/P1 버그수정 (타이머, 보스 페널티, 몬스터 풀, 선택지, 스킵, API, 골드) |
| `00771e5` | InputManager, StatsManager 미반영 수정사항 포함 |
| `9b50a25` | 꾸미기 아이템 크로스 디바이스 동기화 수정 |
| `6f87e0f` | 버그 수정: null 체크, await 누락, 이미지 포맷 검증 추가 |
| `20f6672` | DialogManager, BattleScreen, StatsScreen 미반영 수정사항 포함 |
| `8f774ae` | P0/P1 수정: 동기화 락, API키 헤더전송, 업적조건일치 등 7건 |
| `40415ba` | DialogManager, StatsScreen, i18n 미반영 수정사항 포함 |
| `ebe5871` | 보스 HP회복 조건 변경: 일반몬스터 회복 제거, 중간보스 5회/최종보스 10회 |

---

## 수정 파일 목록 (총 18개)

| 파일 | 수정 횟수 | 주요 변경 |
|------|-----------|-----------|
| `BattleManager.js` | 6회 | 타이머, 보스 페널티, 스킵 상한, 골드 보너스, await, HP회복 |
| `MonsterManager.js` | 4회 | 선택지 검증, null 체크, 초반 난이도 제한 |
| `Game.js` | 3회 | ESC 폴링, 몬스터 부활, null 체크 |
| `ApiService.js` | 2회 | 타임아웃, 꾸미기 동기화 병합 |
| `PlayerManager.js` | 2회 | 꾸미기 마이그레이션 서버 동기화 |
| `AchievementManager.js` | 2회 | async 전환, 업적 조건 수정 |
| `ShopManager.js` | 1회 | async 전환 |
| `EffectSystem.js` | 1회 | 데미지 텍스트 2.5배 |
| `GeminiService.js` | 2회 | 이미지 포맷 검증, API 키 헤더 전송 |
| `ProblemGeneratorService.js` | 1회 | 이미지 포맷 검증 |
| `StatsManager.js` | 1회 | 과목별 유형 집계 |
| `StatsScreen.js` | 1회 | 과목별 유형 카드 UI |
| `ResultScreen.js` | 1회 | 스크롤 지원 |
| `BattleScreen.js` | 1회 | 하단 버튼 간격 |
| `DialogManager.js` | 1회 | 기존 수정사항 반영 |
| `constants.js` | 1회 | 업적 조건값 수정 |
| `i18n.js` | 1회 | 번역 키 추가 |
| `main.js` | 2회 | ESC 핸들러, 동기화 락 |

---

## 미해결 사항

1. **ESC 키 뒤로가기**: 4가지 방식 시도했으나 미동작 (원인 미파악)
2. **P2 밸런스 조정**: 골드 경제, 아이템 가격/효과, 난이도별 보상 차등
3. **P3 개선**: DialogManager 메모리 누수, 입력 검증 강화, i18n 폴백, 통계 성능
