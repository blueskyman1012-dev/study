# AI 문제생성 플랫폼별 테스트 및 딜레이 개선

## 작업일: 2026-02-02

## 코드 경로 추적 결과

### 발견한 문제

#### 1. `startDungeon`에서 Gemini 폴백 없음 (치명적)
- 기존: SmilePrint API 키가 있을 때만 AI 문제 자동 생성
- Gemini 키만 가진 사용자는 문제 부족 시 던전 입장 불가
- **수정**: SmilePrint 실패 시 Gemini 폴백, Gemini 키만 있어도 직접 생성

#### 2. 폴링 초기 딜레이 (딜레이 원인)
- 기존: SmilePrint 상태 확인 전 매번 `sleep(1000)` 고정
- 첫 폴링에서 불필요하게 1초 대기, 빠른 응답도 최소 1초 지연
- **수정**: 적응형 폴링 (300ms → 800ms → 1500ms)
  - 첫 확인: 300ms (서버가 빠르면 바로 완료 감지)
  - 초기 5회: 800ms (대부분 여기서 완료)
  - 이후: 1500ms (장시간 작업용)

### 플랫폼별 경로 검증

#### Android Chrome
- **카메라**: `navigator.mediaDevices.getUserMedia` → 카메라 모달 → 촬영 → canvas capture → base64
- **AI 생성**: FormData + Blob + fetch → 정상 동작
- **더미 이미지**: `document.createElement('canvas')` → toDataURL → atob → Blob → 정상

#### iOS Safari
- **카메라**: `<input type="file" capture="environment">` → 파일 선택 → FileReader → base64
- **AI 생성**: 동일 (FormData + Blob + fetch는 iOS 11+ 지원)
- **더미 이미지**: 동일 → 정상

### 딜레이 분석

| 경로 | 기존 시간 | 개선 후 |
|------|----------|---------|
| SmilePrint 생성 (빠른 응답) | 3초 + 1초(첫대기) = 4초 | 3초 + 0.3초 = 3.3초 |
| SmilePrint 생성 (보통) | 8초 + 8초(폴링) = 16초 | 8초 + 5.5초(폴링) = 13.5초 |
| Gemini 직접 생성 | N/A (미지원) | 2-5초 |
| 몬스터 충분 시 던전 입장 | 즉시 | 즉시 |

### 수정 파일

#### `app/src/game/Game.js`
- `startDungeon()`: Gemini 폴백 추가
  - SmilePrint 키 없어도 Gemini로 자동 생성
  - SmilePrint 실패 시 Gemini로 폴백

#### `app/src/services/ProblemGeneratorService.js`
- `waitForCompletion()`: 적응형 폴링 간격 (300ms → 800ms → 1500ms)

#### `app/src/services/ImageAnalysisService.js`
- `waitForCompletion()`: 동일 적응형 폴링 적용
