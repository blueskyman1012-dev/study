# 오답헌터 게임 테스트 및 개선점 분석

**작성일**: 2026-02-09
**분석 범위**: 전체 게임 로직, 서비스 레이어, UI/UX, 테스트 코드

---

## 1. 테스트 실행 결과

총 109개 테스트 중 **4개 실패**:

| 테스트 | 실패 원인 |
|--------|-----------|
| CONST-SUB-002 | SUBJECTS 객체에 `name` 속성 없음 (실제: `nameKey`) |
| CONST-RAR-002 | RARITY 객체에 `name` 속성 없음 (실제: `nameKey`) |
| RND-GRID-001 | drawGrid()가 오프스크린 캔버스 캐싱 사용, mockCtx에 직접 그리지 않음 |
| RND-GRID-002 | 위와 동일 원인 - 캐시된 캔버스에 그려서 메인 ctx 스타일 미변경 |

**원인**: 코드가 다국어 지원으로 리팩토링되면서 `name` → `nameKey`로 변경되었으나 테스트가 미갱신. Renderer는 성능 최적화(오프스크린 캐싱)가 적용되었으나 테스트가 미반영.

---

## 2. 심각한 버그 (즉시 수정 필요)

### 2.1 BattleManager.js - 무한 루프 위험 (Line 147-150)
```javascript
do {
    nextIdx = Math.floor(Math.random() * monster.questions.length);
} while (nextIdx === currentIdx);
```
- 문제가 1개뿐이면 무한 루프로 게임 프리징
- **해결**: 반복 횟수 제한 + 폴백 로직 필요

### 2.2 BattleManager.js - 정답 시 최종보스 페널티 (Line 104-108)
- 정답을 맞혔는데 플레이어가 -10 HP 피해 + 보스 HP 25 회복
- 반직관적 메커니즘으로 게임 밸런스 파괴

### 2.3 MonsterManager.js - AI 생성 실패 시 빈 문제 배열
- `autoGenerateQuestions()` 실패 후 `monster.questions`가 비어있을 수 있음
- 다음 `selectNextQuestion()` 호출 시 undefined 접근으로 크래시

### 2.4 GeminiService.js - HTTP 응답 검증 부족
- `response.ok` 확인 없이 바로 `response.json()` 호출
- `data.candidates[0].content.parts[0].text` 접근 시 null 체크 없음
- 429(속도제한), 401(인증실패) 등 구분 불가

---

## 3. 게임 밸런스 문제

### 3.1 최종보스 난이도 불균형
| 대상 | 오답 피해 | 플레이어 HP 대비 | 생존 가능 횟수 |
|------|----------|----------------|--------------|
| 일반 몬스터 | 25 | 25% | 4회 |
| 일반 보스 | 30 | 30% | 3회 |
| 중간 보스 | 40 + HP회복 | 40% | 2회 |
| 최종 보스 | 80 + HP회복 | 80% | 1회 |

- 최종보스 HP 배수 5x (400~500 HP) 대비 기본 공격력 34로 15턴 이상 필요
- 1회 오답으로 거의 즉사 → 사실상 무결함 플레이 강요

### 3.2 타임아웃 페널티 불일치
- 타임아웃(-45) > 일반 오답(-25): 시간 초과가 답을 틀린 것보다 큰 페널티
- 논리적으로 맞지 않음

### 3.3 보상 변동성 과다
- 골드 획득: 5~20G 랜덤 → 낮은 값(5G) 받으면 허탈감
- 고정 기본값 + 난이도/콤보 보너스 방식 권장

### 3.4 스킵 페널티 부족
- 스킵(-10) vs 오답(-25) vs 타임아웃(-45)
- 스킵이 가장 가벼워서 남용 가능

---

## 4. 성능 문제

### 4.1 MonsterManager.js - 매번 3회 배열 전체 순회
- `selectMonsterByDifficulty()` 호출마다 monsters 배열을 3번 filter
- 몬스터 1000개 기준 던전 1회(100스테이지)에 30만 회 불필요한 비교
- **해결**: 난이도별 인덱싱/캐싱

### 4.2 Game.js - 로딩 중 불필요한 effects 렌더링
- `isGenerating` 상태에서도 `effects.render()` 호출로 CPU 낭비

### 4.3 clickAreas 메모리 누적
- `registerClickArea()`가 매 렌더링마다 호출되면 배열에 중복 누적
- **해결**: 같은 ID 제거 후 추가하는 방식으로 변경

---

## 5. 서비스 레이어 문제

### 5.1 ApiService.js - 침묵적 실패
- 모든 API 오류가 `null`로 반환되어 호출자가 원인 파악 불가
- 401(인증), 429(속도제한), 500(서버오류) 구분 안 됨

### 5.2 ApiService.js - downloadRuns() 데이터 손실 위험
- 기존 로컬 데이터를 먼저 삭제한 후 새 데이터 수신
- 서버가 비어있거나 중간에 실패하면 모든 데이터 소실
- **해결**: 백업 → 삭제 → 수신 → 실패 시 복구 패턴 필요

### 5.3 ImageAnalysisService.js - 재시도 로직 부재
- 일시적 네트워크 오류 시 즉시 실패 (재시도 없음)
- 60번 폴링까지 기다리다 실패해도 원인 불명확

### 5.4 SoundService.js - iOS AudioContext 문제
- iOS에서 사용자 상호작용 전 AudioContext 생성 시 suspended 상태
- resume 처리 로직 부재

---

## 6. 코드 구조 개선점

### 6.1 Game.js 1189줄 - 과도한 책임
- 초기화, 화면 전환, 입력 처리, 오답 등록, UI 모달 등 모든 것이 한 클래스에
- ScreenManager, InputHandler, UIManager 등으로 분해 권장

### 6.2 completeRegister() 146줄 - 거대한 메서드
- SmilePrint → Gemini → 수동입력 폴백 체인이 하나의 메서드에
- 부분 실패 시 불완전한 데이터(빈 question)가 DB에 저장될 수 있음

### 6.3 테스트-코드 불일치
- constants.js가 i18n 지원으로 `name` → `nameKey`로 변경되었으나 테스트 미갱신
- Renderer가 오프스크린 캐싱으로 최적화되었으나 테스트 미반영

---

## 7. 보안 관련

### 7.1 Google Client ID 하드코딩 (main.js:84)
- 소스 코드에 직접 노출
- 환경변수(`import.meta.env.VITE_GOOGLE_CLIENT_ID`)로 이동 권장

### 7.2 API URL 하드코딩 (main.js:13)
- `import.meta.env.VITE_API_URL` 환경변수 사용 권장

---

## 8. 수정 우선순위 로드맵

### 즉시 수정 (이번 주)
| # | 문제 | 파일 | 예상 시간 |
|---|------|------|----------|
| 1 | 무한 루프 위험 | BattleManager.js:147 | 15분 |
| 2 | 정답 시 보스 페널티 | BattleManager.js:104 | 10분 |
| 3 | AI 생성 실패 처리 | MonsterManager.js:383 | 20분 |
| 4 | 테스트 4개 수정 | constants.test.js, Renderer.test.js | 30분 |

### 우선 수정 (1~2주)
| # | 문제 | 파일 | 예상 시간 |
|---|------|------|----------|
| 5 | API 응답 검증 강화 | GeminiService.js | 1시간 |
| 6 | 데이터 동기화 안전화 | ApiService.js | 2시간 |
| 7 | 최종보스 밸런스 조정 | constants.js, BattleManager.js | 1시간 |
| 8 | 난이도별 캐싱 | MonsterManager.js | 30분 |

### 장기 개선 (1개월)
| # | 문제 | 예상 시간 |
|---|------|----------|
| 9 | Game.js 클래스 분해 | 3시간 |
| 10 | 오프라인 지원 추가 | 3시간 |
| 11 | 환경변수 처리 | 30분 |
| 12 | iOS AudioContext 호환 | 1시간 |
