# 심각한 버그 4건 패치 완료

**작성일**: 2026-02-09

---

## 1. 정답 시 최종보스 페널티 제거

**파일**: `app/src/game/BattleManager.js` (Line 104-108)

**변경 전**: 정답을 맞혀도 플레이어 HP -10, 보스 HP +25 회복
```javascript
if (monster.bossType === 'FINAL_BOSS' && game.finalBossWrongLastTurn) {
    this.player.currentHp -= 10;
    monster.hp = Math.min(monster.hp + 25, monster.maxHp);
    game.finalBossWrongLastTurn = false;
}
```

**변경 후**: 정답 시 페널티 플래그만 해제, HP 감소/보스 회복 제거
```javascript
if (monster.bossType === 'FINAL_BOSS' && game.finalBossWrongLastTurn) {
    game.finalBossWrongLastTurn = false;
}
```

---

## 2. 문제 선택 무한 루프 방지

**파일**: `app/src/game/BattleManager.js` (Line 147-150)

**변경 전**: 문제가 적을 때 무한 루프 위험
```javascript
do {
    nextIdx = Math.floor(Math.random() * monster.questions.length);
} while (nextIdx === currentIdx);
```

**변경 후**: 최대 10회 시도 후 순차 폴백
```javascript
let attempts = 0;
do {
    nextIdx = Math.floor(Math.random() * monster.questions.length);
    attempts++;
} while (nextIdx === currentIdx && attempts < 10);
if (nextIdx === currentIdx) {
    nextIdx = (currentIdx + 1) % monster.questions.length;
}
```

---

## 3. 문제 데이터 undefined 접근 방지

**파일**: `app/src/game/BattleManager.js` (Line 153)

**변경 전**: `monster.questions[nextIdx]`가 undefined일 수 있음
**변경 후**: null 체크 후 인덱스 0으로 폴백, questions 배열이 비어있으면 early return

---

## 4. AI 생성 실패 시 빈 문제 배열 방지

**파일**: `app/src/game/MonsterManager.js` (Line 382-388)

**변경 전**: catch 블록에서 `_fillFromAllMonsters()` 실패 시 빈 배열 가능
**변경 후**:
- `_fillFromAllMonsters()`도 try-catch로 감쌈
- 최종적으로 questions 배열이 비어있으면 현재 문제로 1개 보장

---

## 5. Gemini API 응답 검증 강화

**파일**: `app/src/services/GeminiService.js`

**변경 내용**:
- `analyzeImage()`: `response.ok` 체크 추가, HTTP 상태 코드별 에러 메시지
- `generateContent()`: `data.candidates[0].content.parts[0].text` 직접 접근 → optional chaining + null 체크
- 두 메서드 모두 빈 응답 시 명확한 에러 메시지

---

## 테스트 결과

- 전체 109개 테스트 중 105개 통과
- 실패 4개는 기존 테스트 미갱신 문제 (이번 패치와 무관)
  - `CONST-SUB-002`: `name` → `nameKey` 속성명 변경 미반영
  - `CONST-RAR-002`: 동일
  - `RND-GRID-001/002`: 오프스크린 캐싱 도입 후 테스트 미반영
