# 오답헌터 - 기술 문서

## 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                        index.html                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    Canvas (400x700)                  │   │
│  │                                                      │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │              Renderer.js                      │   │   │
│  │  │  - drawText, drawButton, drawHPBar           │   │   │
│  │  │  - roundRect, drawCircle, drawGrid           │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  │                        ▲                             │   │
│  │                        │                             │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │                Game.js                        │   │   │
│  │  │  - 화면 전환, 입력 처리                       │   │   │
│  │  │  - 전투 로직, 보스 시스템                     │   │   │
│  │  │  - 아이템 드랍, 효과음                        │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  │          ▲              ▲              ▲             │   │
│  │          │              │              │             │   │
│  │  ┌───────┴───┐  ┌───────┴───┐  ┌───────┴───┐        │   │
│  │  │Database.js│  │GeminiSvc  │  │SoundSvc   │        │   │
│  │  │IndexedDB  │  │AI 문제생성│  │Web Audio  │        │   │
│  │  └───────────┘  └───────────┘  └───────────┘        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 파일별 역할

### main.js
```javascript
class App {
  canvas, ctx, db, game

  init()           // 초기화
  setupCanvas()    // 캔버스 크기 설정
  resizeCanvas()   // 반응형 리사이즈
  setupEvents()    // 이벤트 리스너
  handleInput(e)   // 터치/클릭 좌표 변환
  showLoading()    // 로딩 화면
  gameLoop()       // requestAnimationFrame 루프
}
```

### Game.js
```javascript
class Game {
  // 상태
  db, player, currentScreen, clickAreas
  battle, currentMonster, monsters
  currentRun, stage, combo, timer
  droppedItem

  // 초기화
  init()
  loadPlayer()
  loadMonsters()
  createNewPlayer()

  // 화면 관리
  changeScreen(screen)
  registerClickArea(id, x, y, w, h, callback)
  clearClickAreas()
  handleInput(x, y)

  // 게임 루프
  update()
  updateBattle()
  render()

  // 화면 렌더링
  renderMainScreen()
  renderRegisterScreen()
  renderBattleScreen()
  renderResultScreen()
  renderSettingsScreen()

  // 전투 시스템
  startDungeon()
  nextMonster()
  getBossType(stage)
  selectAnswer(index)
  onCorrectAnswer()
  onWrongAnswer()
  onTimeOut()
  onMonsterDefeated()
  endRun(isWin)

  // 아이템 시스템
  rollItemDrop(bossType)
  getItemsByRarity(rarity)
  onItemDrop(item)
  showItemDropNotification(item)

  // 기타
  useHint()
  skipQuestion()
  captureAndRegister(subjectId)
  showOcrLoading()
  runOcr(imageData)
  captureImage()
  promptApiKey()
  testAIGeneration()
  generateSimilarMonsters(monster)
  save()
}
```

### Renderer.js
```javascript
class Renderer {
  static ctx, width, height

  static init(ctx, w, h)
  static clear()
  static drawGrid()
  static drawText(text, x, y, options)
  static roundRect(x, y, w, h, radius, fill, stroke)
  static drawCircle(x, y, radius, color)
  static drawHPBar(x, y, w, h, current, max, color)
  static drawButton(x, y, w, h, text, options)
}
```

### Database.js
```javascript
class Database {
  db, dbName, version

  open()
  get(store, key)
  getAll(store)
  getByIndex(store, index, value)
  put(store, data)
  add(store, data)
  delete(store, key)
}
```

### GeminiService.js
```javascript
class GeminiService {
  apiKey

  setApiKey(key)
  loadApiKey()
  hasApiKey()
  generateContent(prompt)
  analyzeQuestion(question, subject)
  generateSimilarProblems(question, answer, subject, count)
  generateNewProblems(subject, topic, count)
  generateHint(question, answer, subject)
  generateExplanation(question, answer, subject)
  parseJSON(text)
}
```

### SoundService.js
```javascript
class SoundService {
  audioContext, enabled, volume

  init()
  toggle()
  setVolume(vol)
  playTone(freq, duration, type, vol)

  // 효과음
  playCorrect()
  playWrong()
  playClick()
  playItemDrop(rarity)
  playCombo(count)
  playTimerWarning()
  playMonsterDefeat()
  playBossAppear()
  playLevelUp()
  playGameOver()
  playClear()
  playDungeonStart()
  playCapture()
  playHint()
  playGold()

  // 진동
  vibrate(pattern)
  playCorrectWithVibrate()
  playWrongWithVibrate()
}
```

### constants.js
```javascript
export const SCREENS = {
  MAIN, BATTLE, RESULT, SHOP, REGISTER, DUNGEON_SELECT, SETTINGS
}

export const GAME_CONFIG = {
  CANVAS_WIDTH: 400,
  CANVAS_HEIGHT: 700,
  DEFAULT_HP: 300,
  DEFAULT_TIME: 30,
  STAGES_PER_DUNGEON: 100
}

export const BOSS_CONFIG = {
  NORMAL_BOSS: { stages, hpMultiplier, damageMultiplier, goldMultiplier, icon, name },
  MID_BOSS: { ... },
  FINAL_BOSS: { ... }
}

export const COLORS = { ... }
export const SUBJECTS = { MATH, ENGLISH, KOREAN, SCIENCE }
export const RARITY = { NORMAL, RARE, EPIC, LEGENDARY }
export const DROP_RATES = { MONSTER: 0.05, BOSS: 0.35 }
```

---

## IndexedDB 스키마

```javascript
// 데이터베이스: OdapHunterDB
// 버전: 1

// Object Stores:
{
  player: {
    keyPath: 'id'
  },
  monsters: {
    keyPath: 'id',
    autoIncrement: true,
    indexes: {
      status: 'status',
      subject: 'subject'
    }
  },
  runs: {
    keyPath: 'id',
    autoIncrement: true
  }
}
```

---

## API 연동

### Gemini API
```javascript
// 엔드포인트
const GEMINI_API_URL =
  'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

// 요청 형식
fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: {
      temperature: 0.7,
      maxOutputTokens: 1024
    }
  })
});

// 응답 형식
{
  candidates: [{
    content: {
      parts: [{ text: '...' }]
    }
  }]
}
```

---

## Web Audio API

```javascript
// 오디오 컨텍스트 생성
const audioContext = new AudioContext();

// 톤 생성
const oscillator = audioContext.createOscillator();
const gainNode = audioContext.createGain();

oscillator.connect(gainNode);
gainNode.connect(audioContext.destination);

oscillator.frequency.value = 440;  // Hz
oscillator.type = 'sine';  // sine, square, sawtooth, triangle

gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

oscillator.start(audioContext.currentTime);
oscillator.stop(audioContext.currentTime + 0.3);
```

---

## OCR (Tesseract.js)

```html
<!-- CDN -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
```

```javascript
// 인식 실행
const result = await Tesseract.recognize(
  imageData,      // base64 이미지
  'kor+eng',      // 언어 (한국어 + 영어)
  {
    logger: m => console.log(m.status, m.progress)
  }
);

// 결과
const text = result.data.text;
```

---

## 빌드 및 배포

### 개발 서버
```bash
npm run dev
# https://localhost:9333
```

### 프로덕션 빌드
```bash
npm run build
# dist/ 폴더에 빌드 결과물
```

### 프리뷰
```bash
npm run preview
# 빌드 결과물 미리보기
```

---

## Vite 설정

```javascript
// vite.config.js
import { defineConfig } from 'vite';

export default defineConfig({
  root: './',
  base: './',
  publicDir: 'public',
  server: {
    port: 9333,
    host: true,    // 0.0.0.0 바인딩
    open: true,
    https: true    // 자체 서명 인증서
  },
  build: {
    outDir: 'dist',
    assetsDir: 'assets'
  }
});
```

---

## 브라우저 호환성

| 기능 | Chrome | Safari | Firefox |
|------|--------|--------|---------|
| Canvas 2D | O | O | O |
| IndexedDB | O | O | O |
| Web Audio | O | O | O |
| Camera Capture | O | O (HTTPS) | O |
| Vibration | O | X | O |
| ES Modules | O | O | O |
