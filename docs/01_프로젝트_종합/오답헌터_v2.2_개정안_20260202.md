# 오답헌터 v2.2 개정안

## 작성일: 2026-02-02

---

## 버전 이력

| 버전 | 날짜 | 주요 내용 |
|------|------|-----------|
| v1.0 | - | 초기 릴리스 (Game.js 단일 파일, IndexedDB 로컬 저장) |
| v1.31 | 2026-01-31 | 클라우드 인프라 설계 (Google OAuth, D1 DB, Workers API, Cloudflare 배포) |
| **v2.2** | **2026-02-02** | **코드 리팩토링 (13파일 분리), 버그 10건 수정, 불필요 코드 삭제** |

---

## Part 1. v1.31 — 클라우드 인프라 설계

### 1.1 현재 데이터 저장 방식의 문제

| 저장 위치 | 키 | 데이터 |
|-----------|-----|--------|
| IndexedDB | player | 플레이어 정보 (레벨, 스탯) |
| IndexedDB | monsters | 오답 몬스터 데이터 |
| IndexedDB | items | 아이템 정보 |
| IndexedDB | runs | 플레이 기록 |
| localStorage | gemini_api_key | Gemini API 키 |
| localStorage | smileprint_api_key | 이미지분석 API 키 |
| localStorage | sfx_enabled, bgm_enabled | 사운드 설정 |

**문제점:**
- 브라우저 캐시 삭제 시 전부 소실
- 기기 변경 시 데이터 이동 불가
- API 키가 브라우저에 평문으로 저장 (보안 취약)

### 1.2 목표 아키텍처

```
[사용자 브라우저/휴대폰]
       ↓ Google 로그인 버튼 클릭
[Google OAuth 2.0]  → ID Token 발급
       ↓
[Cloudflare Workers API]  ← ID Token 검증 + 암호화/복호화
       ↕
[Cloudflare D1 Database]  ← SQLite 기반 서버리스 DB
```

### 1.3 D1 데이터베이스 스키마

| 테이블 | 용도 |
|--------|------|
| `users` | Google 로그인 사용자 (google_id, email, name, picture) |
| `players` | 플레이어 게임 데이터 (level, exp, hp, attack, defense, gold) |
| `monsters` | 오답 몬스터 (subject, question, answer, status) |
| `items` | 아이템 (item_type, item_name, quantity) |
| `runs` | 플레이 기록 (score, monsters_defeated) |
| `user_settings` | 사운드 설정 |
| `encrypted_keys` | API 키 AES-256-GCM 암호화 저장 |

### 1.4 Google OAuth 2.0 로그인 흐름

1. 사용자가 "Google로 로그인" 버튼 클릭
2. Google 로그인 팝업 → 계정 선택
3. Google이 ID Token(JWT) 발급 → 브라우저로 전달
4. 브라우저가 ID Token을 Workers API에 전송 (`POST /api/auth/google`)
5. Workers에서 Google 공개키로 JWT 서명 검증
6. D1에서 사용자 조회 → 없으면 자동 회원가입
7. 세션 토큰(JWT) 발급 → 브라우저로 반환
8. 이후 모든 API 요청에 `Authorization: Bearer <세션토큰>` 포함

### 1.5 Workers API 엔드포인트

| 카테고리 | 엔드포인트 | 메서드 | 설명 |
|----------|-----------|--------|------|
| 인증 | /api/auth/google | POST | Google 로그인 (자동 회원가입) |
| 인증 | /api/auth/me | GET | 현재 사용자 정보 |
| 플레이어 | /api/player | GET/PUT | 플레이어 조회/저장 |
| 몬스터 | /api/monsters | GET/POST | 몬스터 목록/추가 |
| 몬스터 | /api/monsters/:id | PUT/DELETE | 몬스터 수정/삭제 |
| 아이템 | /api/items | GET/POST | 아이템 목록/추가 |
| 기록 | /api/runs | GET/POST | 플레이 기록 |
| 설정 | /api/settings | GET/PUT | 사운드 설정 |
| API 키 | /api/keys | POST | API 키 암호화 저장 |
| API 키 | /api/gemini/generate | POST | Gemini 프록시 호출 |
| API 키 | /api/image/analyze | POST | 이미지 분석 프록시 |

> API 키 조회(GET) 엔드포인트는 만들지 않음 — 키가 브라우저로 나가면 안 됨

### 1.6 API 키 암호화

- **알고리즘**: AES-256-GCM (인증된 암호화)
- **마스터 키**: Workers Secret으로 보관
- **암호화**: Workers에서 랜덤 IV 생성 → AES-GCM 암호화 → D1에 암호문+IV 저장
- **복호화**: Workers 내부에서만 복호화, 브라우저로 전송 안 함

### 1.7 보안 설계

| 항목 | 방법 |
|------|------|
| 통신 | HTTPS (Cloudflare 자동) |
| 인증 | Google OAuth 2.0 → 세션 JWT |
| API 키 | AES-256-GCM 암호화 후 D1 저장 |
| 마스터키 | Workers Secret |
| CORS | Pages 도메인만 허용 |

### 1.8 Workers 프로젝트 구조

```
study-api/
├── wrangler.toml
├── schema.sql
├── src/
│   ├── index.js              (라우터)
│   ├── middleware/
│   │   ├── auth.js           (JWT 검증)
│   │   └── cors.js           (CORS)
│   ├── routes/
│   │   ├── auth.js           (Google OAuth)
│   │   ├── player.js         (플레이어 CRUD)
│   │   ├── monsters.js       (몬스터 CRUD)
│   │   ├── items.js          (아이템 CRUD)
│   │   ├── runs.js           (플레이 기록)
│   │   ├── settings.js       (설정)
│   │   └── keys.js           (API 키 암호화)
│   └── utils/
│       ├── crypto.js         (AES-GCM)
│       ├── jwt.js            (세션 JWT)
│       ├── google.js         (Google Token 검증)
│       └── response.js       (응답 헬퍼)
└── package.json
```

### 1.9 Cloudflare 배포 인프라

- **Cloudflare Pages**: 프론트엔드 배포 (`study-bhi.pages.dev`)
- **Cloudflare Workers**: 백엔드 API (`study-api.workers.dev`)
- **Cloudflare D1**: 서버리스 SQLite DB (`odap-hunter-db`)
- **Cloudflare Tunnel**: PC/서버 외부 공개 (선택)

### 1.10 D1 무료 범위

| 항목 | 무료 한도 |
|------|----------|
| 저장 용량 | DB당 500MB |
| DB 개수 | 10개 |
| 읽기 | 일 500만 rows |
| 쓰기 | 일 10만 rows |

---

## Part 2. v2.2 — 코드 리팩토링

### 2.1 파일 분리

#### 기존 구조
- `Game.js` 단일 파일 (3,487줄)

#### 리팩토링 후 구조
```
app/src/game/
├── Game.js               (메인 컨트롤러 - 초기화, render, 화면전환, 등록, 데이터관리)
├── EffectSystem.js        (파티클, 플로팅텍스트, 화면흔들림, 플래시)
├── BattleManager.js       (전투 로직 - 정답/오답, 데미지, 타이머, 콤보, 힌트)
├── MonsterManager.js      (몬스터 선택, 보스, 난이도, AI문제생성)
├── PlayerManager.js       (레벨, 경험치, 스탯 계산, 저장)
├── ShopManager.js         (상점 구매 로직 - 통일된 가격 함수)
├── ItemManager.js         (아이템 드랍, 효과 적용)
└── screens/
    ├── MainScreen.js      (메인 화면 렌더링)
    ├── BattleScreen.js    (전투 화면 렌더링)
    ├── ResultScreen.js    (결과 화면)
    ├── ShopScreen.js      (상점 화면)
    ├── SettingsScreen.js  (설정 화면)
    └── RegisterScreen.js  (오답 등록 화면)
```

#### 역할 분담

| 파일 | 역할 |
|------|------|
| **Game.js** | 메인 컨트롤러: 초기화, update/render 루프, 화면 전환, 클릭 영역 관리, 데이터 내보내기/가져오기 |
| **EffectSystem.js** | 시각 효과: 파티클 폭발, 데미지/골드/콤보 플로팅 텍스트, 화면 흔들림, 플래시 |
| **BattleManager.js** | 전투 핵심: 정답/오답 처리, 타이머, 콤보, 힌트, 스킵, 다음 문제 선택 |
| **MonsterManager.js** | 몬스터 관리: 난이도별 선택, 보스 시스템(3단계), AI 유사문제 생성 |
| **PlayerManager.js** | 플레이어 관리: 레벨/경험치, 스탯 계산(HP/데미지/시간), 저장 |
| **ShopManager.js** | 상점: 영구 업그레이드 구매, 소모품 구매, 통일된 가격 계산 |
| **ItemManager.js** | 아이템: 드랍 테이블, 랜덤 드랍, 효과 적용 |
| **screens/*.js** | 각 화면의 렌더링 전담 |

### 2.2 버그 수정 내역 (10건)

| # | 버그 | 원인 | 수정 |
|---|------|------|------|
| 1 | 플로팅 텍스트 속성 불일치 | `life: 1.2` (초 단위)가 ms 기반 시스템과 불일치 | `life: 1200`, `speed: 1.5`, `maxLife`, `alpha`, `scale` 추가 |
| 2 | 결과 화면 `/10` 하드코딩 | 스테이지 수가 변경되면 틀림 | `${GAME_CONFIG.STAGES_PER_DUNGEON}` 사용 |
| 3 | `this.player.upgrades` 참조 | 실제 필드명은 `permanentUpgrades` | `player.permanentUpgrades` 사용 |
| 4 | `GAME_CONFIG.DEFAULT_TIME` 참조 오류 | constants.js에 있지만 참조가 잘못됨 | 정상 참조하도록 수정 |
| 5 | 레벨업 효과음 | `playClick()` 호출 (클릭 소리) | `playLevelUp()` 호출 |
| 6 | 상점 가격 표시/실제 불일치 | 표시용과 구매용 가격 계산이 별도 | `ShopManager.getUpgradePrice()` 통일 함수 |
| 7 | 부활 아이템 드랍 저장 위치 | 런 데이터에만 저장 (런 종료 시 소실) | `player.inventory.reviveTicket`에 직접 추가 |
| 8 | 스킵 시 문제 안 바뀜 | `selectNextQuestion()` 미호출 | 호출 추가 |
| 9 | 시간초과 시 문제 안 바뀜 | `selectNextQuestion()` 미호출 | 호출 추가 |
| 10 | 몬스터 처치 시 영구 삭제 | `status: 'defeated'`로 변경 후 복구 안 됨 | `status: 'cleared'` 사용, 런 클리어 시 `alive`로 복구 |

### 2.3 삭제된 불필요 코드

| 함수 | 이유 |
|------|------|
| `captureImage()` | main.js에서 카메라 처리하므로 Game에서 중복 |
| `runOcr()` | Tesseract OCR 미사용 (AI API로 대체됨) |
| `showOcrLoading()` | OCR 로딩 화면 (미사용) |

### 2.4 빌드 및 테스트 결과

| 항목 | 결과 |
|------|------|
| Vite 빌드 | 성공 (경고/에러 없음) |
| 모듈 수 | 24 modules |
| 번들 크기 | 92.37 kB (gzip: 30.06 kB) |
| 단위 테스트 | Game.test.js 41/41 통과 |
| Dev 서버 | 모든 모듈 정상 로드 (HTTP 200) |

### 2.5 변경되지 않은 파일

- `canvas/Renderer.js` — 렌더링 엔진
- `services/SoundService.js` — 사운드
- `services/GeminiService.js` — Gemini API
- `services/ImageAnalysisService.js` — 이미지 분석
- `services/ProblemGeneratorService.js` — 문제 생성
- `data/Database.js` — IndexedDB
- `utils/constants.js` — 상수
- `main.js` — 앱 진입점
- `style.css` — 스타일

---

## Part 3. 전체 프로젝트 구조 (v2.2 현재)

```
app/
├── index.html
├── src/
│   ├── main.js                         (앱 진입점, 카메라, 리사이즈)
│   ├── style.css
│   ├── game/
│   │   ├── Game.js                     (메인 컨트롤러)
│   │   ├── EffectSystem.js             (시각 효과)
│   │   ├── BattleManager.js            (전투 로직)
│   │   ├── MonsterManager.js           (몬스터 관리)
│   │   ├── PlayerManager.js            (플레이어 관리)
│   │   ├── ShopManager.js              (상점)
│   │   ├── ItemManager.js              (아이템)
│   │   └── screens/
│   │       ├── MainScreen.js           (메인 화면)
│   │       ├── BattleScreen.js         (전투 화면)
│   │       ├── ResultScreen.js         (결과 화면)
│   │       ├── ShopScreen.js           (상점 화면)
│   │       ├── SettingsScreen.js       (설정 화면)
│   │       └── RegisterScreen.js       (오답 등록 화면)
│   ├── canvas/
│   │   └── Renderer.js                 (캔버스 렌더링 엔진)
│   ├── services/
│   │   ├── SoundService.js             (사운드)
│   │   ├── GeminiService.js            (Gemini API)
│   │   ├── ImageAnalysisService.js     (이미지 분석)
│   │   └── ProblemGeneratorService.js  (문제 생성)
│   ├── data/
│   │   └── Database.js                 (IndexedDB)
│   └── utils/
│       └── constants.js                (게임 상수)
├── tests/
│   └── unit/
│       ├── game/Game.test.js           (게임 테스트 41건)
│       └── canvas/Renderer.test.js     (렌더러 테스트)
└── vite.config.js

study-api/                              (Workers 백엔드 - v1.31 설계)
├── wrangler.toml
├── schema.sql
├── src/
│   ├── index.js
│   ├── middleware/ (auth.js, cors.js)
│   ├── routes/ (auth, player, monsters, items, runs, settings, keys)
│   └── utils/ (crypto, jwt, google, response)
└── package.json
```

---

## Part 4. 향후 작업 (미구현)

| 우선순위 | 항목 | 상태 |
|----------|------|------|
| 1 | Google OAuth 로그인 구현 (프론트엔드) | 구현 완료 |
| 2 | Workers API 백엔드 구현 | 구현 완료 |
| 3 | D1 데이터베이스 생성 및 스키마 적용 | 구현 완료 |
| 4 | IndexedDB → Workers API 전환 (데이터 동기화) | 구현 완료 |
| 5 | API 키 암호화 저장 전환 | 설계 완료, 미구현 |
| 6 | 테스트 (로그인, API, 보안, 동기화) | 테스트 계획서 작성 완료 |

---

## 참고 문서

| 문서 | 내용 |
|------|------|
| `D1클라우드저장방안_20260131.md` | D1 스키마, OAuth 흐름, API 설계, 암호화 상세 |
| `구글로그인_테스트계획서_20260131.md` | Google 로그인 + D1 저장 테스트 항목 |
| `Cloudflare설정가이드_20260131.md` | Pages/Tunnel 배포 가이드 |
| `Cloudflare_API토큰_설정가이드_20260131.md` | API 토큰, Wrangler 설정 |
| `오답헌터_리팩토링_완료보고서_20260202.md` | 리팩토링 상세 보고서 |
