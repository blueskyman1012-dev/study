# 문제생성화면 미종료 버그 수정

## 날짜
2026-02-23

## 문제점
- AI 문제 생성/오답 등록 시 로딩 화면(⏳)이 완료/에러/취소 후에도 캔버스에 남아있음
- `isGenerating = false`를 설정해도 `_needsRender = true`가 없으면 캔버스가 다시 그려지지 않음

## 근본 원인: 게임 루프 구조

```
gameLoop() → update() → _needsRender 체크 → render()
```

- `update()`에서 `isGenerating === true`이면 매 프레임 `_needsRender = true` 설정
- `isGenerating`이 `false`가 되면 `else` 분기로 이동 → `_needsRender`를 설정하지 않음
- 결과: 마지막으로 그린 로딩 화면(⏳)이 캔버스에 영구 잔류

## 전체 `isGenerating = false` 점검 결과

### 수정 전 현황

| 파일 | 위치 | `_needsRender` | 상태 |
|------|------|:-:|:-:|
| AIGenerateManager:26 | `_finishAndShowResult` | true | OK |
| AIGenerateManager:94 | `testAI` finally | **없음** | **BUG** |
| AIGenerateManager:108 | `showMenu` finally | **없음** | **BUG** |
| Game.js:156 | 취소 버튼 | true | OK |
| Game.js:201 | ESC 핸들러 | 219에서 설정 | OK |
| Game.js:237 | 65초 타임아웃 | **없음** | **BUG** |
| Game.js:287 | 캔버스 터치 취소 | true | OK |
| Game.js:590 | `_autoFillProblems` finally | true | OK |
| RegisterManager:62 | SmilePrint 성공 | **없음** | **BUG** |
| RegisterManager:79 | Gemini 폴백 성공 | **없음** | **BUG** |
| RegisterManager:92 | Gemini 폴백 실패 | **없음** | **BUG** |
| RegisterManager:99 | SmilePrint 실패+Gemini 없음 | **없음** | **BUG** |
| RegisterManager:115 | Gemini 분석 성공 | **없음** | **BUG** |
| RegisterManager:128 | Gemini 분석 실패 | **없음** | **BUG** |
| RegisterManager:140 | finally 블록 | **없음** | **BUG** |

**총 10곳 버그**

### RegisterManager 재현 시나리오
1. 사진 등록 → 로딩 화면(⏳) 표시
2. API 분석 실패 → `isGenerating = false` (but NO `_needsRender`)
3. 에러 모달 표시 → 사용자가 닫음
4. 질문 입력 프롬프트 → 사용자가 **취소**
5. 함수가 `return` → `changeScreen(MAIN)` 도달 못함
6. **캔버스에 ⏳ 로딩 화면이 영구히 남음!**

## 수정 내용

### 1. `AIGenerateManager.js` - finally 블록 2곳
- `showAIGenerateMenu()`, `testAIGeneration()` finally에 `_needsRender = true` + `changeScreen(MAIN)` 추가

### 2. `Game.js` - 65초 안전 타임아웃
- `_needsRender = true` 추가

### 3. `RegisterManager.js` - 7곳 전부 수정
- `isGenerating = false` 뒤마다 `_needsRender = true` 추가 (6곳)
- finally 블록에 `_needsRender = true` + `_removeCancelOverlay()` 추가

### 4. 테스트 추가 (`AIGenerateManager.test.js`)
- 취소 시 `_needsRender`와 `changeScreen` 검증
- `testAIGeneration` finally 블록 검증
- DB/네트워크 에러 시 화면 복구 안전망 검증

### 5. 결과 알림 방식 변경 (`_finishAndShowResult`)
- 기존: `showModal()` → 사용자가 "확인" 클릭해야 닫힘 (차단형)
- 변경: `showToast()` → 3초 후 자동 닫힘 (비차단형), 터치 시 즉시 닫힘
- `DialogManager.js`에 `showToast(message, duration)` 메서드 추가
  - 상단 슬라이드인 애니메이션 (toastIn/toastOut)
  - 초록 테두리 성공 알림 스타일
  - 자동 닫힘 + 터치 즉시 닫힘
- `Game.js`에 `showToast` 위임 메서드 추가

## 검증
- `npm run build` 성공
- `npx vitest run` 전체 통과 (8 파일, 213 테스트)
