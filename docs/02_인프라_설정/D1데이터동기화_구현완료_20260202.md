# D1 데이터 동기화 구현 완료 보고서

## 작성일: 2026-02-02

---

## 개요

Google 계정별 데이터 영속화를 위해 프론트엔드와 Cloudflare Workers 백엔드(D1) 간 데이터 동기화를 구현했다.

---

## 변경 사항

### 1. 신규 파일: `app/src/services/ApiService.js`

- 백엔드 API 호출 래퍼 클래스
- 세션 토큰 자동 포함 (`Authorization: Bearer`)
- 지원 메서드: player GET/PUT, monsters GET/POST/PUT, runs POST, settings GET/PUT, keys POST/DELETE
- 오프라인 폴백: API 호출 실패 시 `null` 반환, 로컬 IndexedDB 계속 사용
- `downloadPlayerData()`: 서버 플레이어 데이터 → IndexedDB 덮어쓰기
- `downloadMonsters()`: 서버 몬스터 목록 → IndexedDB 교체

### 2. 수정: `app/src/main.js`

- `apiService` import 추가
- 로그인 성공 시 `apiService.setToken()` 호출
- 세션 검증 성공 시 토큰 설정
- 로그아웃 시 토큰 제거
- `showGame()`에서 서버 데이터 다운로드 후 게임 초기화

### 3. 수정: `app/src/game/Game.js`

- `apiService` import 추가
- `completeRegister()`: 몬스터 등록 시 서버에도 `POST /api/monsters` 비동기 호출
- `endRun()`: 런 종료 시 서버에 `POST /api/runs` 비동기 호출

### 4. 수정: `app/src/game/PlayerManager.js`

- `apiService` import 추가
- `save()`: IndexedDB 저장 후 서버에 `PUT /api/player` 비동기 호출

### 5. 수정: `app/src/game/MonsterManager.js`

- `apiService` import 추가
- `onMonsterDefeated()`: 몬스터 처치 시 서버에 상태 업데이트 (`PUT /api/monsters/:id`)

### 6. 수정: `docs/오답헌터_v2.2_개정안_20260202.md`

- 향후 작업 표에서 항목 1~4 상태를 "구현 완료"로 변경

---

## 동기화 전략

| 시점 | 동작 |
|------|------|
| 로그인 시 | 서버 데이터 → IndexedDB 덮어쓰기 (서버가 진실의 원천) |
| 게임 중 저장 | IndexedDB 즉시 저장 + 서버 비동기 저장 |
| API 실패 시 | 경고 로그만 출력, IndexedDB 데이터로 정상 진행 |
| 미로그인 시 | 기존처럼 IndexedDB만 사용 (게스트 모드) |

---

## ShopManager 참고

- ShopManager는 별도 수정 불필요: 구매 후 `playerManager.save()` 호출 → 자동으로 서버 동기화됨

---

## 검증 방법

1. `npm run dev`로 로컬 실행
2. Google 로그인 → 콘솔에 "서버 데이터 동기화 완료" 확인
3. 오답 등록 → 서버 저장 확인
4. 던전 플레이 후 종료 → 런 기록 서버 저장 확인
5. 다른 브라우저에서 같은 계정 로그인 → 데이터 동일 확인
6. `npm run test`로 기존 테스트 통과 확인
