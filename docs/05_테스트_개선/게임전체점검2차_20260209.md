# 게임 전체 점검 2차

> 작성일: 2026-02-09 (1차 점검 후 버그 수정 반영 상태에서 재점검)

---

## 1. 긴급 수정 (Critical)

### 1-1. 동기화 Race Condition
- **위치**: `main.js` 545~563줄
- **문제**: `syncFromServer()`에 락(lock) 메커니즘 없음 → `visibilitychange` 이벤트 빠르게 2회 발생 시 동시 동기화로 데이터 손상 가능
- **제안**: `this._syncing = true` 플래그 추가, 동기화 완료 후 해제

### 1-2. API 키 URL 노출
- **위치**: `GeminiService.js` 79, 131줄
- **문제**: `?key=${this.apiKey}` 쿼리 파라미터로 API 키 전송 → 브라우저 히스토리, 프록시 로그에 노출
- **제안**: Authorization 헤더로 전송 방식 변경

### 1-3. 동기화 중 데이터 삭제-추가 비원자적 처리
- **위치**: `ApiService.js` 188~243줄 (downloadRuns), 348~414줄 (downloadMonsters)
- **문제**: 기존 데이터 전부 삭제 후 새 데이터 추가 → 중간에 실패 시 데이터 유실
- **제안**: 트랜잭션 기반 원자적 처리 또는 업데이트 방식으로 변경

---

## 2. 게임 밸런스 문제

### 2-1. 골드 경제 병목 (레벨 5~20)
| 항목 | 현재 값 | 문제 | 제안 |
|------|---------|------|------|
| 기본 골드 | 5~21G/정답 | 초반 구매력 부족 | 레벨 20 이하 2배 보너스 |
| goldBonus 업그레이드 | 레벨10 이후 가격 급등 | 8,000G+ 필요 | 가속 완화 (0.05 → 0.03) |
| HP 업그레이드 | +10 HP/레벨 | 보스 피해(40~60)에 비해 미미 | +15 HP/레벨 |
| 시간 업그레이드 | +3초/레벨, 최대 5레벨 | 총 +15초뿐 | +5초/레벨 또는 최대 8레벨 |

### 2-2. 보스 전투 밸런스
| 보스 유형 | 현재 | 문제 | 제안 |
|-----------|------|------|------|
| 중간 보스 | HP회복 30, 피해 40 | 오답 1회당 순손실 70 → 사실상 3회 오답이면 사망 | HP회복 20, 피해 35 |
| 최종 보스 | HP배율 5x (500HP) | 최소 10회 정답 필요, 10분+ 전투 | HP배율 4x (400HP) |
| 최종 보스 연속 오답 | -60 + 추가-5 + 몬스터HP+15 | 연속 오답 시 사실상 즉사 | 추가 페널티 3연속부터 적용 |

### 2-3. 아이템 가성비
| 아이템 | 가격 | 효과 | 문제 | 제안 |
|--------|------|------|------|------|
| 부활권 | 500G | HP 50% 회복 | 25~100회 정답 필요, 부활 후 즉사 가능 | 300G, HP 75% 회복 |
| 2배 골드 | 500G | 1.25x 배율 1회 | 순손실 -425G | 1.5x 배율 또는 250G |
| 힌트권 | 100G | 오답 1개 제거 | 정답 보장 안됨 | 50G |

### 2-4. 난이도별 보상 미분화
- **위치**: `BattleManager.js` 97~105줄
- **문제**: 난이도 1(쉬움)과 난이도 3(어려움) 문제의 골드/경험치 보상 동일
- **제안**: 난이도 3 → 1.5x 보상, 난이도 1 → 0.8x 보상

---

## 3. 로직 버그

### 3-1. 업적 ID와 조건 불일치
| 업적 ID | 현재 조건 | 기대 조건 |
|---------|-----------|-----------|
| `answer_100` | 200회 정답 | 100회 정답 |
| `gold_1000` | 3000G 보유 | 1000G 보유 |
| `kills_50` | 80마리 처치 | 50마리 처치 |

- **위치**: `AchievementManager.js` 198, 207, 219줄
- **제안**: ID에 맞게 조건 수정하거나, 조건에 맞게 ID 변경

### 3-2. 보스 오답 시 다중 힐링
- **위치**: `BattleManager.js` 230~247줄
- **문제**: `_wrongCounts`가 문제별로 추적됨 → 같은 보스전에서 다른 문제에 오답 시 각각 몬스터 HP 회복 → 보스 여러 번 풀힐 가능
- **제안**: 보스 HP 회복 횟수 상한 설정 (최대 3회)

### 3-3. 초반 5문제 난이도 무작위
- **위치**: `MonsterManager.js` 51~72줄
- **문제**: `totalAnswers < 5`면 완전 랜덤 → 신규 유저가 난이도3 문제 만날 수 있음
- **제안**: 첫 5문제는 난이도 1~2로 제한

---

## 4. UI/UX 개선점

### 4-1. 전투 화면
| 항목 | 위치 | 문제 | 제안 |
|------|------|------|------|
| 하단 버튼 간격 | BattleScreen 184~207 | 4개 버튼 10px 간격 → 모바일 오터치 | 간격 16px 확보 |
| 선택지 말줄임 | BattleScreen 151~152 | 문자 수(12자) 기준 → 글자 너비 무시 | 14자 또는 픽셀 기준 측정 |
| 문제 텍스트 줄바꿈 | BattleScreen 105~126 | 22자 하드코딩 → 수식/영어 잘림 | 실제 픽셀 너비 기반 줄바꿈 |
| 보스 아이콘 오버플로우 | BattleScreen 82~87 | 보스 등장 시 아이콘 75~90px → HUD 영역 침범 | 아이콘 최대 크기 제한 |

### 4-2. 결과 화면
| 항목 | 위치 | 문제 | 제안 |
|------|------|------|------|
| 카드 높이 초과 | ResultScreen 25~30 | 데이터 많으면 700px 초과 → 버튼 안 보임 | 스크롤 지원 추가 |
| 구분선 미계산 | ResultScreen 25~30 | cardH 계산에 구분선/패딩 미포함 | 정확한 높이 계산 |

### 4-3. 상점 화면
| 항목 | 위치 | 문제 | 제안 |
|------|------|------|------|
| 대량구매 터치영역 | ShopScreen 398 | 터치영역이 버튼 위 7px 확장 → 다른 버튼과 겹침 | 터치영역 정렬 |
| 탭-콘텐츠 경계 | ShopScreen 74~101 | 탭바와 콘텐츠 사이 0px → 탭/콘텐츠 클릭 혼동 | 8px 간격 추가 |
| 비활성 버튼 | ShopScreen 301~307 | 구매 불가 시 시각 피드백 불일치 | 일관된 비활성 스타일 |

### 4-4. 통계 화면
| 항목 | 위치 | 문제 | 제안 |
|------|------|------|------|
| 로딩 상태 없음 | StatsScreen 111~119 | 데이터 없음만 표시 | 로딩/에러 상태 구분 |
| Y축 라벨 겹침 | StatsScreen 467~475 | graphX-8 = 37px → 뒤로가기 버튼과 겹침 가능 | 위치 조정 |
| 링 그래프 오버플로우 | StatsScreen 141~159 | 우측 링 cx=320, r=40 → 360px까지 확장 | 여백 확보 |

### 4-5. 설정 화면
| 항목 | 위치 | 문제 | 제안 |
|------|------|------|------|
| 투명도 슬라이더 | SettingsScreen 126~146 | 최소값에서 핸들 위치 벗어남 | 핸들 위치 clamp 처리 |
| 언어 버튼 배치 | SettingsScreen 102~116 | 4개×80px+6px gap = 366px → 우측 여백 부족 | 70px로 축소 |

### 4-6. 업적 화면
| 항목 | 위치 | 문제 | 제안 |
|------|------|------|------|
| 보상 수령 버튼 | AchievementScreen 86~95 | x=300, w=70 → 370px, 우측 여백 10px만 | x=290으로 이동 |

### 4-7. 공통 문제
| 항목 | 문제 | 제안 |
|------|------|------|
| 뒤로가기 버튼 크기 | 화면별 (80×40) vs (80×35) 불일치 | 80×40으로 통일 |
| 메인 메뉴 버튼 크기 | 4개 버튼 총 너비 364px > 카드 360px | 버튼 너비 82px로 조정 |
| 큰 숫자 표시 | 999,999,999G 등 오버플로우 | 축약 표시 (999M) |

---

## 5. 서비스/인프라 문제

### 5-1. 메모리 누수
| 위치 | 문제 | 심각도 |
|------|------|--------|
| DialogManager 34~86 | 기존 모달 remove() 시 리스너 미정리 | 높음 |
| SoundService 203~255 | bgmNodes 배열에 오실레이터 누적 가능 | 중간 |
| main.js 81~93 | Google API 체크 setInterval 미해제 케이스 | 낮음 |

### 5-2. 입력 검증 부족
| 위치 | 문제 |
|------|------|
| ProblemGeneratorService 311~323 | topic, difficulty, count 범위 체크 없음 |
| GeminiService 117~123 | API 응답에서 answer, choices 존재 검증 없음 |
| ImageAnalysisService 98~175 | 이미지 크기 제한 없음 → 메모리 이슈 |

### 5-3. 데이터 동기화
| 항목 | 문제 | 제안 |
|------|------|------|
| 타임스탬프 없음 | 서버/로컬 데이터 신구 판별 불가 | lastSyncTime 필드 추가 |
| 충돌 해결 없음 | 동시 변경 시 서버 값 무조건 우선 | 타임스탬프 기반 최신 데이터 사용 |
| 동기화 재시도 없음 | 초기 동기화 실패 시 재시도 없음 | 3회 재시도 로직 추가 |

### 5-4. i18n 문제
| 항목 | 문제 | 제안 |
|------|------|------|
| 기본 언어 | 항상 한국어 폴백 | 브라우저 언어 감지 후 폴백 |
| 번역 누락 | 일부 키 번역 없으면 키 이름 그대로 표시 | 폴백 체인 구현 (en → ko) |

---

## 6. 성능 최적화

### 6-1. 통계 재계산
- **위치**: `StatsManager.js` 46~59줄
- **문제**: 통계 화면 진입 시 전체 runs + 전체 monsters O(n²) 재계산
- **제안**: 증분 업데이트 또는 캐시 TTL 연장

### 6-2. 문제 풀 부족
- **위치**: `MonsterManager.js` 376~404줄
- **문제**: 몬스터당 5~10문제 → 100스테이지 던전에서 문제 반복 심함
- **제안**: AI 자동 생성 적극 활용 또는 최소 15문제 확보

---

## 7. 게임플레이 개선 아이디어

### 7-1. 난이도별 보상 차등
- 쉬움(×0.8), 보통(×1.0), 어려움(×1.5) 보상 배율

### 7-2. 전투 중 저장
- 10스테이지마다 자동 저장 → 브라우저 크래시 시 복구

### 7-3. 콤보 끊김 피드백
- 시간초과/오답 시 "콤보 끊김!" 시각 효과 추가

### 7-4. 초반 난이도 가이드
- 첫 5문제 난이도 1~2 제한, 이후 점진적 상승

---

## 우선순위 정리

### P0 (즉시 수정)
1. 동기화 Race Condition (락 추가)
2. API 키 URL 노출 → 헤더 전송
3. 업적 ID/조건 불일치

### P1 (빠른 수정)
4. 보스 HP 회복 횟수 상한
5. 초반 5문제 난이도 제한
6. 결과 화면 스크롤 지원
7. 전투 하단 버튼 간격 확보

### P2 (밸런스 조정)
8. 골드 경제 재조정 (초반 보너스, 업그레이드 가격)
9. 보스 전투 밸런스 (HP배율, 페널티)
10. 아이템 가격/효과 조정
11. 난이도별 보상 차등

### P3 (개선)
12. DialogManager 메모리 누수 수정
13. 입력 검증 강화
14. i18n 폴백 체인
15. 통계 성능 최적화
16. 전투 UI (선택지, 문제 텍스트, 아이콘)
