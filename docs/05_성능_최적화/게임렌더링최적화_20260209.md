# 게임 렌더링 최적화 완료

> 작성일: 2026-02-09

## 개요
60fps requestAnimationFrame 루프에서 정적 화면(로비, 상점, 통계 등)에서도 매 프레임 전체 렌더링이 실행되어 CPU/GPU 부담이 발생하던 문제를 해결했다.

## 수정 내역

### 1. Dirty 렌더링 (프레임 스킵)

**문제**: 로비·상점·통계 등 정적 화면에서도 60fps 풀 렌더링 실행 → 불필요한 CPU/GPU 사용

**해결**: `_needsRender` 플래그 기반 조건부 렌더링

| 파일 | 변경 내용 |
|------|-----------|
| `Game.js` | `_needsRender` 플래그 추가, `requestRender()` 메서드, `changeScreen()`에서 자동 설정, `update()`에서 전투/생성/이펙트 시만 활성화 |
| `main.js` | 게임 루프에서 `_needsRender === false`면 render() 및 DOM 업데이트 건너뜀 |
| `InputManager.js` | 클릭 영역 히트 시 `_needsRender = true`, 터치 스크롤 시 `_needsRender = true` |

**효과**: 정적 화면에서 렌더링 ~90% 감소 (이벤트 발생 시에만 렌더)

### 2. EffectSystem 배치 최적화

**문제**: 파티클/텍스트 삭제 시 splice() → O(n²), save/restore 개별 호출

**해결**:

| 항목 | Before | After |
|------|--------|-------|
| 파티클 삭제 | `splice(i, 1)` O(n²) | swap-pop 방식 O(n) |
| 텍스트 삭제 | `splice(i, 1)` O(n²) | swap-pop 방식 O(n) |
| 파티클 렌더링 | 개별 save/restore | 배치 (1회 save/restore) |
| 텍스트 렌더링 | 개별 save/restore | 배치 (공용 strokeStyle/lineWidth) |
| 조기 종료 | 없음 | `hasActiveEffects()` 체크 후 조기 종료 |

**효과**: 파티클 100개 기준 삭제 연산 ~50% 감소, 렌더링 save/restore 호출 100→1회

## 수정 파일 목록

- `app/src/game/Game.js` - dirty 렌더링 플래그 + update 조건부 활성화
- `app/src/main.js` - 게임 루프 프레임 스킵
- `app/src/game/InputManager.js` - 입력 시 렌더 플래그 설정
- `app/src/game/EffectSystem.js` - hasActiveEffects, swap-pop, 배치 렌더링

---

### 3. Renderer 캐시 최적화 (폰트/색상/그라데이션)

**문제**: 매 프레임 drawText에서 정규식 파싱, lightenColor/darkenColor에서 색상 변환, drawHPBar/drawTimerBar에서 그라데이션 생성이 반복 실행

**해결**:

| 캐시 대상 | 키 | 효과 |
|-----------|-----|------|
| `_fontCache` (Map) | font 파라미터 문자열 (예: `bold 16px system-ui`) | 정규식 파싱 → 캐시 조회로 대체, `_lastFont`로 ctx.font 할당 스킵 |
| `_colorCache` (Map) | `${color}_L${percent}` / `${color}_D${percent}` | HP바 3색 × lighten/darken = 6개 엔트리로 대부분 커버 |
| `_gradientCache` (Map) | `HP_${x}_${y}_${h}_${color}` / `TM_${x}_${y}_${h}_${color}` | 고정 위치 HP바/타이머바 그라데이션 재사용 |

**효과**: drawText 호출당 정규식 0회, HP바/타이머바 그라데이션 생성 0회 (캐시 히트)

### 4. Game.js 스크롤 렌더 헬퍼 통합

**문제**: SETTINGS, SHOP, STATS, ACHIEVEMENT 4개 화면에서 동일한 save/restore + 스크롤바 코드가 중복

**해결**: `_renderScrollableScreen(renderFn, headerFn)` 헬퍼 메서드 추출
- save → translate(-scrollY) → renderFn() → restore → headerFn() → 스크롤 인디케이터
- 4개 화면의 코드 중복 제거 (save/restore 4→1 패턴)

### 5. MonsterManager 난이도별 인덱스

**문제**: `selectMonsterByDifficulty()`에서 매번 `this.monsters.filter()` 3회 호출 (easy/medium/hard)

**해결**: `_difficultyIndex = { easy: [], medium: [], hard: [] }` 프리빌드 인덱스
- `loadMonsters()`, `loadMonstersBySubject()`, `onMonsterDefeated()` 시 `_buildDifficultyIndex()` 호출
- `selectMonsterByDifficulty()`에서 인덱스 직접 참조 (filter 0회)

**효과**: 몬스터 선택 시 배열 순회 3회 → 0회

### 6. StatsManager 캐시 + 단일 패스 최적화

**문제**: `aggregateStats()` 호출 시 매번 전체 DB 로드 + 정렬 + 별도 filter/reduce 3회

**해결**:

| 항목 | Before | After |
|------|--------|-------|
| DB 결과 캐시 | 없음 | `_cachedStats` + `_cacheKey` (`런수_몬스터수_마지막런시간`) |
| 시간순 정렬 | `[...runs].sort()` 항상 실행 | 이미 정렬 여부 확인 후 스킵 |
| 최근 10런 계산 | filter 1회 + reduce 2회 (3회 순회) | 단일 for 루프로 recentClears/recentTotal/recentCorrect 동시 계산 |
| 캐시 무효화 | 없음 | `invalidateCache()` — 런 완료 시 호출 |

## 수정 파일 목록 (추가)

- `app/src/canvas/Renderer.js` - 폰트/색상/그라데이션 3종 캐시
- `app/src/game/Game.js` - 스크롤 렌더 헬퍼 추출 + stats 캐시 무효화
- `app/src/game/MonsterManager.js` - 난이도별 인덱스 (`_difficultyIndex`)
- `app/src/game/StatsManager.js` - 통계 캐시 + 단일 패스 최적화

## 검증 결과

- 단위 테스트: 145/145 통과 (`npx vitest run`)
- 프로덕션 빌드: 성공 (240.27 KB JS, 3.55 KB CSS)
- 정적 화면 CPU 사용량: 대폭 감소 (렌더 프레임 ~90% 스킵)
- drawText 호출당 정규식: 0회 (캐시 적중)
- HP바/타이머바 그라데이션 생성: 0회 (캐시 적중)
- 몬스터 난이도 선택 filter: 3회 → 0회
- 통계 집계: 캐시 히트 시 DB 재로드 없이 즉시 반환
