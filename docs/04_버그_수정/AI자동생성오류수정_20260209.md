# AI 자동 문제 생성 버그 수정

> 작성일: 2026-02-09

## 개요
문제가 부족할 때 AI가 자동으로 문제를 생성하는 기능에서 4가지 버그를 발견하고 수정했다.

## 발견된 버그

### 1. ProblemGeneratorService API 키 미갱신 (치명적)

**증상:** SmilePrint API 키를 설정해도 자동 생성 시 SmilePrint를 사용하지 않음

**원인:** `ProblemGeneratorService`가 생성자에서만 API 키를 로드하고, 이후 `ImageAnalysisService.setApiKey()`로 키가 설정되어도 반영하지 않음.

```javascript
// 변경 전: 생성자에서만 로드
hasApiKey() {
    return !!this.apiKey;  // 항상 null → false
}

// 변경 후: 매번 최신 키 확인
hasApiKey() {
    this.loadApiKey();     // sessionStorage에서 재로드
    return !!this.apiKey;
}
```

**영향 범위:**
- `MonsterManager.autoGenerateQuestions()` — 문제 부족 시 자동 생성
- `MonsterManager._generateBossQuestion()` — 보스 난이도 보장
- `BattleManager.onWrongAnswer()` — 오답 시 유사 문제 생성

### 2. reshuffleChoices 정답 불일치 (중요)

**증상:** AI 생성 문제에서 정답을 맞출 수 없는 경우 발생

**원인:** `reshuffleChoices()`에서 `choices.indexOf(answer)`가 -1을 반환해도 처리하지 않음. AI가 반환한 answer 문자열이 choices 배열에 정확히 일치하지 않으면 `correctIndex = -1`이 되어 어떤 선택지를 골라도 오답 처리됨.

```javascript
// 변경 전: -1이면 정답 불가
monster.correctIndex = monster.choices.indexOf(answer);

// 변경 후: answer가 없으면 강제 삽입
if (answer && !monster.choices.includes(answer)) {
    monster.choices[0] = answer;
}
monster.choices = shuffleArray([...monster.choices]);
monster.correctIndex = monster.choices.indexOf(answer);
```

### 3. _generateBossQuestion 비동기 레이스 컨디션 (중요)

**증상:** 쉬운 몬스터가 보스로 승격될 때 문제가 교체되지만 선택지가 검증되지 않음

**원인:** `_generateBossQuestion()`은 비동기로 실행되며, 완료 후 `monster.question/answer/choices`를 직접 교체하지만 `_prepareChoices()`를 호출하지 않아 셔플/정답검증 없이 표시됨.

**수정:** 비동기 완료 후 `this._prepareChoices(monster)` 호출 추가

### 4. AI 생성 문제 무검증 push (보통)

**증상:** AI가 빈 question/answer를 반환하거나 choices에 answer가 없는 문제가 DB에 저장됨

**수정:** 모든 문제 push 지점에 검증 추가:
- `p.question && p.answer` 필수 조건 체크
- `choices`에 `answer`가 없으면 `choices[0]`에 강제 삽입
- 적용 범위: `autoGenerateQuestions`, `_generateBossQuestion`, `generateSimilarWithProblemGenerator`, `generateSimilarMonsters`

## 수정 파일 목록

| 파일 | 수정 내용 |
|------|-----------|
| `app/src/services/ProblemGeneratorService.js` | `hasApiKey()`에서 `loadApiKey()` 호출 |
| `app/src/game/BattleManager.js` | `reshuffleChoices()`에서 정답 강제 삽입 |
| `app/src/game/MonsterManager.js` | `_generateBossQuestion` 후 `_prepareChoices` 호출, 4곳 문제 push 검증 추가 |

## 검증 결과

- 단위 테스트: 145/145 통과
- 프로덕션 빌드: 성공
