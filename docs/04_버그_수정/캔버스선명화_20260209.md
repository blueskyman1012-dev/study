# 캔버스 HiDPI 렌더링 (글씨 선명화)

## 날짜
2026-02-09

## 문제
캔버스 버퍼가 400x700 고정 해상도로 설정되어 있어, 고해상도 기기(DPR 2~3)에서 CSS로 확대 표시될 때 픽셀이 늘어나 글씨와 UI가 흐릿하게 보임.

## 원인
`canvas.width/height`가 논리 픽셀(400x700)로 고정되어 있어 물리 해상도를 활용하지 못함.

## 해결 방법
`window.devicePixelRatio`를 적용하여 물리 해상도에 맞는 캔버스 버퍼를 사용.

### 원리
- 캔버스 버퍼: `400*dpr x 700*dpr` (물리 픽셀)
- CSS 크기: 기존과 동일 (논리 크기)
- `ctx.scale(dpr, dpr)` 적용 → 모든 드로잉 코드는 기존 400x700 논리 좌표 그대로 사용
- DPR 상한: 3 (성능 보호)

## 수정 파일

### 1. `app/src/main.js` - `setupCanvas()`
```javascript
setupCanvas() {
    const dpr = Math.min(window.devicePixelRatio || 1, 3);
    this.canvas.width = GAME_CONFIG.CANVAS_WIDTH * dpr;
    this.canvas.height = GAME_CONFIG.CANVAS_HEIGHT * dpr;
    this.ctx.scale(dpr, dpr);
    this.resizeCanvas();
}
```

### 2. `app/src/main.js` - 입력 좌표 변환 (5곳)
`this.canvas.width`를 `GAME_CONFIG.CANVAS_WIDTH`로, `this.canvas.height`를 `GAME_CONFIG.CANVAS_HEIGHT`로 변경.
canvas.width가 이제 400*dpr이므로, 입력 좌표를 논리 좌표(400x700)로 변환하려면 논리 크기를 기준으로 해야 함.

변경 위치:
- mousedown 이벤트 핸들러
- mousemove 이벤트 핸들러
- touchstart 이벤트 핸들러
- touchmove 이벤트 핸들러
- handleInput 메서드

### 3. `app/src/canvas/Renderer.js` - `drawGrid()` 그리드 캐시
오프스크린 캔버스도 DPR 적용:
```javascript
const dpr = Math.min(window.devicePixelRatio || 1, 3);
offscreen.width = this.width * dpr;
offscreen.height = this.height * dpr;
oc.scale(dpr, dpr);
// ... 기존 그리드 드로잉 코드 (논리 좌표 그대로) ...
// 메인 캔버스에 그릴 때 논리 크기 지정
this.ctx.drawImage(this._gridCache, 0, 0, this.width, this.height);
```

## 영향 없는 부분
- Renderer.init(): 논리 크기(400, 700)를 받으므로 변경 불필요
- Renderer의 모든 드로잉 메서드: 논리 좌표 사용 → ctx.scale에 의해 자동 확대
- Game.js render(): ctx.save/restore가 scale 포함하여 정상 동작
- capture-canvas: 별도 캔버스이므로 영향 없음
- GuideManager: 논리 좌표이므로 정상 동작
- EffectSystem: 논리 좌표 사용 → 정상

## 검증 결과
- `npx vite build` → 빌드 성공
- `npx vitest run` → 180개 테스트 전체 통과
