# 코드 점검 및 버그 수정 (2026-02-09)

## 수정 내역 (5건)

### 1. [높음] finalBossWrongLastTurn 초기화 누락
- **파일**: `Game.js` → `startDungeon()`
- **문제**: 새 던전 시작 시 `finalBossWrongLastTurn` 플래그가 리셋되지 않음
- **영향**: 이전 런에서 최종보스 오답 후 사망 → 새 런에서 최종보스 첫 오답부터 추가 페널티(HP -10, 보스 HP+25) 적용
- **수정**: `startDungeon()`에 `this.finalBossWrongLastTurn = false;` 추가

### 2. [중간] endRun await 누락 (2곳)
- **파일**: `BattleManager.js` → `onTimeOut()`, `skipQuestion()`
- **문제**: `game.endRun(false)`를 await 없이 호출 → 런 저장/업적 처리 완료 전 후속 코드 실행 가능
- **수정**: `await game.endRun(false)` 로 변경 (2곳)

### 3. [중간] 클라이언트/서버 상태 이름 불일치
- **파일**: `MonsterManager.js` → `onMonsterDefeated()`
- **문제**: 로컬 DB에는 `status: 'cleared'`, 서버 API에는 `status: 'defeated'`로 전송
- **영향**: 서버-클라이언트 동기화 시 상태 불일치 발생 가능
- **수정**: 서버 전송 시에도 `status: 'cleared'`로 통일

### 4. [낮음] 그라디언트 캐시 무한 증가
- **파일**: `Renderer.js` → `drawHPBar()`, `drawTimerBar()`
- **문제**: `_gradientCache`에 eviction 정책 없음. 타이머 바 펄싱 색상 교대로 캐시 엔트리 계속 증가
- **수정**: `_evictGradientCache()` 메서드 추가 (50개 초과 시 전체 클리어)

### 5. [낮음] 몬스터 부활 순차 DB 쓰기
- **파일**: `Game.js` → `_reviveClearedMonsters()`
- **문제**: for 루프에서 `await this.db.put()` 순차 호출 → cleared 몬스터 많으면 느림
- **수정**: `Promise.all()`로 병렬 처리, 빈 배열 조기 반환 추가

## 수정 파일 목록
- `app/src/game/Game.js`
- `app/src/game/BattleManager.js`
- `app/src/game/MonsterManager.js`
- `app/src/canvas/Renderer.js`

## 검증
- Vite 빌드: 성공 (38 modules, 251.87 kB)
- 단위 테스트: 6개 파일, 180개 테스트 전부 통과
