# AI 문제 생성 완료 후 중복 알림 버그 수정

## 작성일: 2026-02-23

---

## 증상
- AI 문제 생성 완료 후 "생성 완료" 알림 창이 반복적으로 표시됨
- 특히 **모바일 환경**에서 모달 확인 버튼 탭 후 동일 좌표의 캔버스 버튼이 트리거됨
- "AI 문제 생성중..." 화면에서 메인화면으로 돌아가지 못하는 현상

## 원인 분석

### 1차 원인: `testAIGeneration()` 중복 호출 방지 락 부재
- 설정 화면의 "테스트 생성" 버튼에 `_aiGenerating` 락이 없었음
- `isGenerating` 플래그 미설정으로 캔버스 입력이 차단되지 않음
- 모달 표시 중 `isGenerating = true` 상태 불일치

### 2차 원인 (근본 원인): 모바일 고스트 클릭
- **모바일 브라우저의 터치→클릭 합성 메커니즘**이 핵심 원인
- 모달 OK 버튼을 탭하면 `touchend` → `modal.remove()` 실행
- ~300ms 후 브라우저가 동일 좌표에 합성 `click` 이벤트 발생
- 모달이 이미 제거되어 합성 클릭이 **캔버스**에 전달됨

### 3차 원인: 취소 오버레이가 모달을 가림
- 전체 화면을 덮는 투명 취소 오버레이(z-index:9999)가 모달 상호작용 방해
- `overlay.onclick = doCancel`이 화면 전체에 적용되어 의도치 않은 취소 발생
- 모달 표시 전에 오버레이가 제거되지 않아 모달 클릭이 차단됨

## 수정 내용

### 1차 수정: `AIGenerateManager.js` 락 및 상태 관리

#### `testAIGeneration()` 수정
| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| 중복 방지 | 없음 | `_aiGenerating` 락 추가 (try/finally) |
| 로딩 표시 | `showModal` (사용자 확인 필요) | `isGenerating = true` (자동 로딩 화면) |
| 모달 표시 시점 | `isGenerating` 무관 | 생성 완료 후 `isGenerating = false` 다음에 모달 표시 |

### 2차 수정: 고스트 클릭 방지

#### `DialogManager.js`
- `_lastDismissTime` 속성 추가, `_onDismiss()` 메서드로 모달 닫힘 시각 기록

#### `InputManager.js`
- 400ms 쿨다운 체크로 고스트 클릭 차단

### 3차 수정: 취소 기능 + API 타임아웃

- `_generationCancelled` 플래그 + 60초 API 타임아웃 (`Promise.race`)
- DOM 취소 오버레이 + 캔버스 취소 영역 (백업)
- ESC 키로 취소 지원

### 4차 수정: 메인화면 전환 보장 + 오버레이 간섭 해결

#### 문제
- 생성 완료 후 메인화면으로 전환되지 않음
- 전체 화면 투명 오버레이가 모달 클릭을 가로채 모달을 닫을 수 없음
- 취소 시 `return`으로 인해 `changeScreen(SCREENS.MAIN)` 미실행

#### `Game.js` 수정
| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| 취소 오버레이 | 전체 화면 투명 div (z-index:9999), `overlay.onclick=doCancel` | 하단 버튼만 표시, `pointer-events:none` 배경, 버튼만 `pointer-events:auto` |
| 안전 타임아웃 | 120초 | 65초 (API 60초 + 여유 5초) |
| 타임아웃 시 | `isGenerating=false`만 | `changeScreen(SCREENS.MAIN)` 추가 |
| ESC 취소 | `isGenerating=false`만 | `changeScreen(SCREENS.MAIN)` 추가 |
| 캔버스 취소 | `isGenerating=false`만 | `changeScreen(SCREENS.MAIN)` 추가 |
| `_autoFillProblems` | finally에 `_removeCancelOverlay` 없음 | finally에 `_removeCancelOverlay()` 추가 |

#### `AIGenerateManager.js` 수정
| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| 취소 처리 | `if (cancelled) return` (changeScreen 건너뜀) | `if (!cancelled)` 조건문 (finally 항상 실행) |
| 정리 함수 | 분산된 cleanup 코드 | `_forceCleanup()` 메서드로 통합 |
| 오버레이 제거 | 모달 표시 후 외부 finally에서만 | 모달 표시 **전** inner finally에서 즉시 제거 |
| 메인화면 전환 | 외부 try 내부에서 호출 | 외부 **finally**에서 호출 (항상 실행 보장) |
| 이중 보호 | `isGenerating=false` 1회 | inner + outer finally 양쪽에서 `_forceCleanup()` |

### 핵심 변경 원리
1. **오버레이 비간섭**: `pointer-events:none` 배경 + 버튼만 `pointer-events:auto` → 모달 클릭 차단 안함
2. **모달 전 정리**: `_forceCleanup()`이 모달 표시 전에 실행 → 오버레이 제거 후 모달 표시
3. **항상 메인으로**: `changeScreen(SCREENS.MAIN)`이 **finally** 블록에 위치 → 성공/실패/취소 무관하게 실행
4. **이중 안전**: inner finally + outer finally 양쪽에서 `_forceCleanup()` 호출
5. **조건문 방식**: `return` 대신 `if (!cancelled)` 조건 → finally 블록이 항상 정상 실행

## 수정된 파일
| 파일 | 변경 내용 |
|------|-----------|
| `Game.js` | 취소 오버레이 `pointer-events:none`, 65초 안전 타임아웃, 취소 시 `changeScreen(MAIN)`, `_autoFillProblems` finally에 `_removeCancelOverlay()` |
| `AIGenerateManager.js` | `_forceCleanup()` 메서드, 취소 조건문 방식, finally에서 `changeScreen(MAIN)`, 모달 전 오버레이 제거 |
| `DialogManager.js` | `_lastDismissTime` 속성, `_onDismiss()` 메서드 추가 |
| `InputManager.js` | 고스트 클릭 쿨다운 + `isGenerating` 시 취소 허용 |
| `RegisterManager.js` | 이미지 분석 시 `_generationCancelled` + 60초 타임아웃 |

## 테스트
| 테스트 파일 | 테스트 수 | 내용 |
|-------------|-----------|------|
| `AIGenerateManager.test.js` | 17개 | 중복 알림, 락 동작, 상태 일관성, 교차 락, `textCleaner` mock |
| `GhostClick.test.js` | 11개 | 400ms 쿨다운, 연속 모달, AI 버튼 좌표, 취소 버튼 허용/차단 |

전체 테스트: 8파일 208개 통과
