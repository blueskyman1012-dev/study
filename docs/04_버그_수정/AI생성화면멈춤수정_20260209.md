# AI 생성 화면 로비 복귀 불가 버그 수정

## 날짜
2026-02-09

## 증상
AI가 문제를 생성하는 로딩 화면(⏳ 스피너)에서 로비로 돌아가지 못하는 현상.
사용자 입력이 완전히 차단되어 앱을 새로고침해야만 복귀 가능.

## 원인 분석
`game.isGenerating` 플래그가 `true`로 설정되면:
- `Game.js:183-200`: 로딩 화면만 렌더링하고 다른 화면 렌더링을 건너뜀
- `InputManager.js:38`: 모든 사용자 입력(터치/클릭)을 차단

이 플래그를 수동으로 `false`로 설정하는 코드가 여러 곳에 흩어져 있었으나, 예외 발생 시 일부 경로에서 `false` 설정을 건너뛰어 플래그가 `true`로 영구 고정됨.

## 수정 내용

### 1. `app/src/game/AIGenerateManager.js` - `_doAIGenerateMenu()`
**문제**: `game.isGenerating = false`가 try/catch 내 수동 호출로만 존재. `generateProblems()`, `showModal()` 등에서 예상치 못한 예외 시 플래그 미해제.
**수정**: `finally` 블록으로 변경하여 어떤 예외에서도 반드시 해제.

```javascript
// 변경 전
try {
  game.isGenerating = true;
  ...
} catch (err) {
  ...
  game.isGenerating = false;
}

// 변경 후
try {
  game.isGenerating = true;
  ...
} catch (err) {
  ...
} finally {
  game.isGenerating = false;
}
```

### 2. `app/src/game/RegisterManager.js` - `completeRegister()`
**문제**: SmilePrint 분석 → Gemini 폴백 → 수동 입력의 3단계 분기에서 `game.isGenerating = false`가 6곳에 흩어져 있음. 중첩 try/catch 구조에서 예상치 못한 예외 시 플래그 미해제.
**수정**: 전체 AI 분석 블록(SmilePrint/Gemini/수동입력 분기)을 `try/finally`로 감싸서 안전망 추가. 기존의 개별 `false` 설정은 그대로 유지(로딩 오버레이를 사용자 프롬프트 전에 해제하기 위함).

```javascript
try {
  if (imageAnalysisService.hasApiKey()) {
    // SmilePrint → Gemini 폴백 로직 (기존 코드 유지)
  } else if (geminiService.hasApiKey()) {
    // Gemini 전용 로직 (기존 코드 유지)
  } else {
    // 수동 입력
  }
} finally {
  game.isGenerating = false;  // 최종 안전망
}
```

## 검증
- Vite 빌드: 성공 (38 modules, 453ms)
- Vitest: 5파일 145 테스트 전체 통과
