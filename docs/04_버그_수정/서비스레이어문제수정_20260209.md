# 서비스 레이어 문제 수정

## 날짜
2026-02-09

## 개요
`게임테스트_개선점분석_20260209.md` 섹션 5에서 식별된 서비스 레이어 4개 문제 일괄 수정.

---

## 수정 내역

### 5.1 ApiService.js - 침묵적 실패 해결
**문제**: 모든 API 오류가 `null`로 반환되어 호출자가 원인 파악 불가

**수정**:
- `ERROR_TYPES` 상수 추가 (AUTH, RATE_LIMIT, SERVER, NETWORK, UNKNOWN)
- `classifyError(status)` 함수로 HTTP 상태 코드 자동 분류
- `_fetch()` 내에서 오류 타입별 로그 레벨 분리:
  - 401/403 → `🔒 [인증 오류]` (warn)
  - 429 → `⏳ [속도 제한]` (warn)
  - 500+ → `🔥 [서버 오류]` (error)
  - 네트워크 실패 → `🌐 [네트워크 오류]` (warn)
- `lastError` 프로퍼티 + `getLastError()` 메서드로 외부에서 오류 타입 조회 가능

### 5.2 ApiService.js - downloadRuns/downloadMonsters 데이터 손실 방지
**문제**: 기존 로컬 데이터를 먼저 삭제한 후 서버 데이터 수신 → 중간 실패 시 데이터 소실

**수정** (백업 → 삭제 → 수신 → 실패시 복구 패턴):
- `downloadRuns()`: 기존 runs를 `backup` 배열에 보관 → 삭제 → 서버 데이터 저장 → catch에서 backup 복구
- `downloadMonsters()`: 동일한 패턴 적용 (alive + cleared 몬스터 모두 백업)

### 5.3 ImageAnalysisService.js - 재시도 로직 추가
**문제**: 일시적 네트워크 오류 시 즉시 실패, 60번 폴링 대기 후에도 원인 불명확

**수정**:
- `checkStatus()`: 최대 3회 재시도 + 지수 백오프 (1s, 2s)
  - 4xx 클라이언트 오류는 재시도 없이 즉시 throw
  - 5xx/네트워크 오류만 재시도
- `waitForCompletion()`: 연속 오류 카운터 추가
  - 5회 연속 네트워크 오류 시 조기 중단 (원인 메시지 포함)
  - 서버의 명시적 실패(failed)는 즉시 throw
- `analyzeImage()`: Job 생성 요청에 최대 2회 재시도
  - 401/403/400은 재시도 없이 즉시 throw

### 5.4 SoundService.js - iOS AudioContext suspended 상태 처리
**문제**: iOS에서 사용자 상호작용 전 AudioContext 생성 시 suspended 상태로 소리 안 남

**수정**:
- `init()`: AudioContext 생성 실패 시 try/catch + 로그 (크래시 방지)
- `init()`: suspended 상태 감지 시 `resume()` 호출
- `playTone()`: suspended 상태면 resume 시도 후 early return (에러 방지)
- `_playNoiseBurst()`: suspended 상태 체크 추가
- `_playLobbyLoop()`: suspended 시 resume → 완료 후 자동 재시도 (Promise.then)

---

## 검증
- `npx vitest run` → 109개 테스트 전체 통과
- `npx vite build` → 빌드 성공 (225KB)

## 수정 파일
| 파일 | 변경 요약 |
|------|-----------|
| `app/src/services/ApiService.js` | 오류 분류 + 백업/복구 패턴 |
| `app/src/services/ImageAnalysisService.js` | 재시도 + 지수 백오프 + 연속 오류 감지 |
| `app/src/services/SoundService.js` | iOS AudioContext resume 처리 |
