# 보안 취약점 패치 완료

> 작성일: 2026-02-09

## 개요
코드베이스 보안 분석 후 핵심 4가지 취약점을 패치했다.

## 패치 내역

### 1. XSS 방지 (DialogManager.js)

**취약점**: showModal, showConfirm, showPrompt에서 `innerHTML`에 사용자/AI 콘텐츠가 이스케이프 없이 삽입됨
- `message` 파라미터에 `<script>` 태그 삽입 가능
- showPrompt의 `value="${defaultValue}"`에서 `"` 문자로 속성 탈출 가능

**수정**:
- `escapeHtml()` 함수 추가 (`& < > " '` 이스케이프)
- showModal, showConfirm, showPrompt의 `${message}` → `${escapeHtml(message)}`
- showPrompt의 `value="${defaultValue}"` → `value="${escapeHtml(defaultValue)}"`

### 2. 세션토큰 보호 (sessionStorage 전환)

**취약점**: session_token과 API 키가 localStorage에 저장 → 탭 종료 후에도 영구 잔류, XSS 시 탈취 용이

**수정**:
- `storage.js`에 `secureGetItem/secureSetItem/secureRemoveItem` 추가 (sessionStorage 사용)
- 민감 데이터 (session_token, gemini_api_key, smileprint_api_key) → sessionStorage 전환
- 비민감 데이터 (sound_volume, language, bg_theme 등) → localStorage 유지
- `main.js`에 1회성 마이그레이션 로직 추가 (기존 localStorage 키 → sessionStorage 이동 후 삭제)

| 파일 | 변경 |
|------|------|
| `utils/storage.js` | secureGet/Set/Remove 함수 3개 추가 |
| `main.js` | session_token + API 키 secureStorage 전환, _migrateSensitiveKeys() |
| `services/GeminiService.js` | gemini_api_key secureStorage 전환 |
| `services/ImageAnalysisService.js` | smileprint_api_key secureStorage 전환 |
| `services/ProblemGeneratorService.js` | smileprint_api_key secureStorage 전환 |

### 3. 입력값 검증 (RegisterManager.js)

**취약점**: 사용자 편집 문제/정답이 검증 없이 DB/서버/AI 프롬프트에 전달
- HTML 태그 삽입 가능
- 길이 제한 없음

**수정**:
- `_sanitize(text, maxLen)` 메서드 추가: HTML 태그 제거 + trim + 길이 제한
- 몬스터 저장 직전 전체 문자열 필드 sanitize:
  - question (1000자), answer (200자), explanation (1000자)
  - topic (100자), formula (500자), answers/choices (각 200자), keywords (각 50자)
- `_safeErrorMsg(err)` 메서드 추가: 에러 메시지에서 URL/파일경로/스택 제거 (100자 제한)

### 4. CSP 헤더 (index.html)

**취약점**: Content-Security-Policy 미설정 → 임의 스크립트/리소스 로드 가능

**수정**: `<meta http-equiv="Content-Security-Policy">` 추가
- `script-src 'self' cdn.jsdelivr.net accounts.google.com` (Tesseract + Google Login)
- `connect-src 'self'` + 백엔드 3개 도메인 (study-api, googleapis, wizice)
- `img-src 'self' data: blob:` (카메라 캡처용)
- `object-src 'none'` (플러그인 차단)
- `base-uri 'self'` (base 태그 하이재킹 방지)
- `frame-src accounts.google.com` (Google 로그인 팝업)

## 수정 파일 목록

- `app/src/game/DialogManager.js` - escapeHtml 적용
- `app/src/utils/storage.js` - secureStorage 래퍼 추가
- `app/src/main.js` - 토큰/키 sessionStorage 전환 + 마이그레이션
- `app/src/services/GeminiService.js` - API 키 sessionStorage 전환
- `app/src/services/ImageAnalysisService.js` - API 키 sessionStorage 전환
- `app/src/services/ProblemGeneratorService.js` - API 키 sessionStorage 전환
- `app/src/game/RegisterManager.js` - 입력 sanitize + 에러 마스킹
- `app/index.html` - CSP 메타 태그 추가

## 검증 결과

- 단위 테스트: 109/109 통과
- 프로덕션 빌드: 성공 (234.91 KB JS, 3.55 KB CSS)

## 참고: 미적용 항목 (선택적 후속 작업)

| 항목 | 사유 |
|------|------|
| API 키 URL 파라미터 노출 | Gemini API가 `?key=` 방식만 지원 (Google 공식 사양) |
| 프롬프트 인젝션 방어 | AI 프롬프트 구조 변경 필요, 별도 작업 권장 |
| API 호출 레이트 리밋 | 클라이언트 단독으로는 우회 가능, 서버 측 구현 권장 |
